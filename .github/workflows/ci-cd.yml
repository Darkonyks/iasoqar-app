name: CI/CD Pipeline

permissions:
  contents: read

on:
  push:
    branches: [ "master", "main", "develop" ]
  pull_request:
    branches: [ "master", "main" ]

env:
  PYTHON_VERSION: "3.13"
  DOCKER_COMPOSE_VERSION: "2.23.0"

jobs:
  # ==================== LINT STAGE ====================
  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort pylint bandit safety
    
    - name: Run Black (code formatting check)
      run: |
        black --check --diff .
      continue-on-error: true
    
    - name: Run isort (import sorting check)
      run: |
        isort --check-only --diff .
      continue-on-error: true
    
    - name: Run Flake8 (style guide enforcement)
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Run Bandit (security linting)
      run: |
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . -ll
      continue-on-error: true
    
    - name: Check dependencies for vulnerabilities
      run: |
        safety check --json || true
      continue-on-error: true

  # ==================== BUILD & TEST STAGE ====================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      postgres:
        image: postgis/postgis:16-3.4
        env:
          POSTGRES_DB: isoqar_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libpq-dev gdal-bin libgdal-dev libgeos-dev
    
    - name: Upgrade pip tooling
      run: |
        python -m pip install --upgrade pip setuptools wheel
    
    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Run Django system checks
      run: |
        python manage.py check
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/isoqar_test
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: "False"
    
    - name: Run migrations
      run: |
        python manage.py migrate --noinput
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/isoqar_test
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: "False"
    
    - name: Collect static files
      run: |
        python manage.py collectstatic --noinput
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/isoqar_test
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: "False"
    
    - name: Run tests
      run: |
        python manage.py test company.tests --noinput --verbosity=2
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/isoqar_test
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: "False"
      continue-on-error: false
    
    - name: Build Docker image
      run: |
        docker build -t isoqar-app:${{ github.sha }} .
        docker tag isoqar-app:${{ github.sha }} isoqar-app:latest
    
    - name: Test Docker image
      run: |
        docker run --rm isoqar-app:latest python manage.py check
      env:
        DATABASE_URL: sqlite:///db.sqlite3
        SECRET_KEY: test-secret-key

  # ==================== DEPLOY STAGE ====================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    # Deploy samo sa master/main branch-a
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    environment:
      name: production
      url: https://your-domain.com  # Zameni sa pravim URL-om
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.1
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to server via SSH
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      run: |
        ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
          set -e
          
          echo "üöÄ Starting deployment..."
          
          # Navigiraj u deployment folder
          cd ${{ secrets.DEPLOY_PATH }}
          
          # Pull latest code
          echo "üì• Pulling latest code from Git..."
          git fetch origin
          git checkout ${{ github.ref_name }}
          git pull origin ${{ github.ref_name }}
          
          # Backup database (opciono)
          echo "üíæ Creating database backup..."
          docker compose -f docker-compose.dev.yml exec -T db pg_dump -U postgres isoqar_dev > backup_$(date +%Y%m%d_%H%M%S).sql || true
          
          # Build and restart containers
          echo "üî® Building Docker images..."
          docker compose -f docker-compose.dev.yml build --no-cache
          
          echo "üîÑ Restarting containers..."
          docker compose -f docker-compose.dev.yml down
          docker compose -f docker-compose.dev.yml up -d
          
          # Wait for services to be healthy
          echo "‚è≥ Waiting for services to be ready..."
          sleep 10
          
          # Run migrations
          echo "üóÑÔ∏è  Running database migrations..."
          docker compose -f docker-compose.dev.yml exec -T web python manage.py migrate --noinput
          
          # Collect static files
          echo "üì¶ Collecting static files..."
          docker compose -f docker-compose.dev.yml exec -T web python manage.py collectstatic --noinput
          
          # Clean up old Docker images
          echo "üßπ Cleaning up old Docker images..."
          docker image prune -f
          
          echo "‚úÖ Deployment completed successfully!"
        ENDSSH
    
    - name: Health check
      run: |
        sleep 5
        curl -f ${{ secrets.APP_URL }}/health/ || echo "‚ö†Ô∏è  Health check failed, but deployment continued"
      continue-on-error: true
    
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ Deployment successful!"
        else
          echo "‚ùå Deployment failed!"
        fi

  # ==================== ROLLBACK JOB (Manual trigger) ====================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.1
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Rollback to previous version
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      run: |
        ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
          set -e
          
          echo "‚è™ Starting rollback..."
          
          cd ${{ secrets.DEPLOY_PATH }}
          
          # Git rollback
          git reset --hard HEAD~1
          
          # Rebuild and restart
          docker compose -f docker-compose.dev.yml build
          docker compose -f docker-compose.dev.yml down
          docker compose -f docker-compose.dev.yml up -d
          
          echo "‚úÖ Rollback completed!"
        ENDSSH
