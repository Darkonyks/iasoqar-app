---
- name: Automatski deploy aplikacije sa GitHub-a
  hosts: all
  become: yes  # ako je potrebno da pišeš po /opt ili root folderima
  vars:
    app_git_repo: "git@github.com:Darkonyks/iasoqar-app.git"   # tvoj github repo
    app_deploy_path: "/home/darko/iasoqar-app"                 # putanja gde će biti deploy
    app_git_version: "master"                                  # ili main, ili drugi branch

  tasks:
    - name: Uveri se da je git instaliran
      ansible.builtin.package:
        name: git
        state: present

    - name: Ko sam ja?
      ansible.builtin.shell: whoami
      register: ko_sam_ja

    - name: Prikazi korisnika
      debug:
        var: ko_sam_ja.stdout

    - name: Kloniraj/Update aplikaciju sa GitHub-a
      ansible.builtin.git:
        repo: "{{ app_git_repo }}"
        dest: "{{ app_deploy_path }}"
        version: "{{ app_git_version }}"
        update: yes
        force: yes
      become: true
      become_user: darko
    - name: Pokreni docker compose (up -d) u aplikacionom folderu
      ansible.builtin.shell: docker compose up -d
      args:
        chdir: /home/darko/iasoqar-app
      become: true
      become_user: darko
    - name: Health-check login strane (prepoznaj po tekstu)
      ansible.builtin.uri:
        url: "http://192.168.5.45:8000/"
        status_code: 200
        return_content: yes
        timeout: 10
      register: healthcheck
    
    - name: Fail ako login stranica nije prepoznata
      ansible.builtin.fail:
        msg: "Aplikacija nije podignuta (nema očekivanog sadržaja na /)!"
      when: "'ISOQAR' not in healthcheck.content"
    - name: Proveri da li je aplikacija dostupna na javnom URL-u
      ansible.builtin.uri:
        url: "http://isoqar.geo-biz.com/"
        status_code: 200
        timeout: 10
      register: healthcheck














