---
- name: Automatski deploy aplikacije sa GitHub-a
  hosts: all
  become: yes  # ako je potrebno da pišeš po /opt ili root folderima
  vars:
    app_git_repo: "git@github.com:Darkonyks/iasoqar-app.git"   # tvoj github repo
    app_deploy_path: "/home/darko/iasoqar-app"                 # putanja gde će biti deploy
    app_git_version: "master"                                  # ili main, ili drugi branch

  tasks:
    - name: Uveri se da je git instaliran
      ansible.builtin.package:
        name: git
        state: present

    - name: Ko sam ja?
      ansible.builtin.shell: whoami
      register: ko_sam_ja

    - name: Prikazi korisnika
      debug:
        var: ko_sam_ja.stdout

    - name: Kloniraj/Update aplikaciju sa GitHub-a
      ansible.builtin.git:
        repo: "{{ app_git_repo }}"
        dest: "{{ app_deploy_path }}"
        version: "{{ app_git_version }}"
        update: yes
        force: yes
      become: true
      become_user: darko

    - name: Proveri da li korisnik darko ima pristup Docker-u
      ansible.builtin.shell: groups darko | grep docker
      register: docker_group_check
      ignore_errors: yes
      
    - name: Dodaj korisnika darko u docker grupu ako nije već dodat
      ansible.builtin.user:
        name: darko
        groups: docker
        append: yes
      when: docker_group_check.rc != 0
      become: yes
      
    - name: Pokušaj zaustaviti kontejnere (docker compose down)
      ansible.builtin.shell: docker compose -p iasoqar-app down
      args:
        chdir: /home/darko/iasoqar-app
      become: yes
      register: docker_down_result
      ignore_errors: yes
      
    - name: Restartuj Docker daemon ako down nije uspeo
      ansible.builtin.systemd:
        name: docker
        state: restarted
      become: yes
      when: docker_down_result.rc != 0
      
    - name: Sačekaj da Docker daemon bude spreman nakon restarta
      ansible.builtin.wait_for:
        path: /var/run/docker.sock
        state: present
        timeout: 30
      become: yes
      when: docker_down_result.rc != 0
      
    - name: Pokreni docker compose build u aplikacionom folderu
      ansible.builtin.shell: docker compose -p iasoqar-app build
      args:
        chdir: /home/darko/iasoqar-app
      become: yes
      
    - name: Pokreni docker compose (up -d) u aplikacionom folderu
      ansible.builtin.shell: docker compose -p iasoqar-app up -d
      args:
        chdir: /home/darko/iasoqar-app
      become: yes
      
    - name: Prikaži status kontejnera
      ansible.builtin.shell: docker compose -p iasoqar-app ps
      args:
        chdir: /home/darko/iasoqar-app
      become: yes
      register: docker_status
      
    - name: Prikaži rezultat
      debug:
        var: docker_status.stdout_lines





















