---
- name: Automatski deploy aplikacije sa GitHub-a
  hosts: all
  become: yes  # ako je potrebno da pišeš po /opt ili root folderima
  vars:
    app_git_repo: "git@github.com:Darkonyks/iasoqar-app.git"   # tvoj github repo
    app_deploy_path: "/home/darko/iasoqar-app"                 # putanja gde će biti deploy
    app_git_version: "master"                                  # ili main, ili drugi branch

  tasks:
    - name: Uveri se da je git instaliran
      ansible.builtin.package:
        name: git
        state: present

    - name: Ko sam ja?
      ansible.builtin.shell: whoami
      register: ko_sam_ja

    - name: Prikazi korisnika
      debug:
        var: ko_sam_ja.stdout

    - name: Kloniraj/Update aplikaciju sa GitHub-a
      ansible.builtin.git:
        repo: "{{ app_git_repo }}"
        dest: "{{ app_deploy_path }}"
        version: "{{ app_git_version }}"
        update: yes
        force: yes
      become: true
      become_user: darko

    - name: Proveri da li korisnik darko ima pristup Docker-u
      ansible.builtin.shell: groups darko | grep docker
      register: docker_group_check
      ignore_errors: yes
      
    - name: Dodaj korisnika darko u docker grupu ako nije već dodat
      ansible.builtin.user:
        name: darko
        groups: docker
        append: yes
      when: docker_group_check.rc != 0
      become: yes
      
    - name: Konfiguriši passwordless sudo za docker komande
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/darko-docker
        line: 'darko ALL=(ALL) NOPASSWD: /usr/bin/docker, /usr/bin/docker-compose, /usr/local/bin/docker-compose'
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'
      become: yes
      
    - name: Restartuj Docker daemon (rešava permission probleme)
      ansible.builtin.systemd:
        name: docker
        state: restarted
      become: yes
      
    - name: Sačekaj da Docker daemon bude spreman
      ansible.builtin.wait_for:
        path: /var/run/docker.sock
        state: present
        timeout: 30
      become: yes
      
    - name: Force kill sve Docker kontejnere (agresivno)
      ansible.builtin.shell: |
        sudo docker kill $(sudo docker ps -q) 2>/dev/null || true
        sudo docker rm -f $(sudo docker ps -aq) 2>/dev/null || true
      args:
        chdir: /home/darko/iasoqar-app
      become: true
      become_user: darko
      ignore_errors: yes
      
    - name: docker compose down (sa sudo)
      ansible.builtin.shell: sudo docker compose down
      args:
        chdir: /home/darko/iasoqar-app
      become: true
      become_user: darko
      ignore_errors: yes  # Ignoriši grešku ako kontejneri nisu pokrenuti
      
    - name: Pokreni docker compose build u aplikacionom folderu (sa sudo)
      ansible.builtin.shell: sudo docker compose build
      args:
        chdir: /home/darko/iasoqar-app
      become: true
      become_user: darko
      
    - name: Pokreni docker compose (up -d) u aplikacionom folderu (sa sudo)
      ansible.builtin.shell: sudo docker compose up -d
      args:
        chdir: /home/darko/iasoqar-app
      become: true
      become_user: darko





















