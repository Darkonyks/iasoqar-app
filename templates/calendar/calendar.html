{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Kalendar Sastanaka{% endblock %}

{% block extrastyle %}
<!-- FullCalendar CSS from CDN -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
<!-- Custom Calendar CSS -->
<link href="{% static 'css/calendar.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="content-wrapper">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0">Kalendar Sastanaka</h1>
        </div>
        <div class="col-sm-6">
          <div class="float-sm-right">
            <button id="createAppointmentBtn" class="btn btn-primary">
              <i class="fas fa-plus"></i> Novi sastanak
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="content">
    <div class="container-fluid">
      <div class="card">
        <div class="card-body">
          <div id="calendar-container">
            <div id="calendar"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- FullCalendar Core -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

<!-- FullCalendar Plugins -->
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@5.11.3/main.global.min.js"></script>

<!-- FullCalendar Localization -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/sr.js"></script>

<!-- Calendar Configuration -->
<script>
  // Configure calendar URLs
  window.eventsApiUrl = '{% url "company:appointment_calendar_json" %}';
  // Za certification_cycle_json je potreban ID parametar koji ćemo prosleđivati dinamički
  // Bazni URL bez ID-a, koji će se formirati dinamički u JS kodu kada dobijemo cycle_id
  window.certificationCycleJsonBaseUrl = '/company/api/cycles/';
  
  // Legacy varijabla za kompatibilnost sa starijim kodom
  window.certificationCycleJsonUrl = '/company/api/cycles/0/json/';
</script>

<!-- Calendar initialization and event handlers -->
<script src="{% static 'js/calendar.js' %}?v=2.0"></script>
<script>
  console.log('HTML template loaded, calendar.js version 2.0 requested');
  // Proveri da li je calendar.js učitan
  setTimeout(function() {
    console.log('Checking if openCycleAuditModal is defined:', typeof openCycleAuditModal === 'function');
  }, 1000);
</script>

<!-- Appointment Modal -->
<div class="modal fade" id="appointmentModal" tabindex="-1" role="dialog" aria-labelledby="appointmentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="appointmentModalLabel">Novi sastanak</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="appointmentForm">
        <div class="modal-body">
          <input type="hidden" id="appointmentId" name="appointmentId">
          
          <div class="form-group">
            <label for="title">Naslov sastanka</label>
            <input type="text" class="form-control" id="title" name="title" required>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="company">Kompanija</label>
                <select class="form-control" id="company" name="company" required>
                  <option value="">Izaberite kompaniju</option>
                  {% for company in companies %}
                  <option value="{{ company.id }}">{{ company.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="appointment_type">Tip sastanka</label>
                <select class="form-control" id="appointment_type" name="appointment_type" required>
                  <option value="">Izaberite tip</option>
                  <option value="audit">Audit</option>
                  <option value="meeting">Sastanak</option>
                  <option value="consultation">Konsultacija</option>
                  <option value="training">Trening</option>
                  <option value="other">Ostalo</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="start_datetime">Vreme početka</label>
                <input type="datetime-local" class="form-control" id="start_datetime" name="start_datetime" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="end_datetime">Vreme završetka</label>
                <input type="datetime-local" class="form-control" id="end_datetime" name="end_datetime" required>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <div class="custom-control custom-checkbox">
              <input type="checkbox" class="custom-control-input" id="all_day" name="all_day">
              <label class="custom-control-label" for="all_day">Celodnevni događaj</label>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="location">Lokacija</label>
                <input type="text" class="form-control" id="location" name="location">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <div class="custom-control custom-checkbox mt-4">
                  <input type="checkbox" class="custom-control-input" id="is_online" name="is_online">
                  <label class="custom-control-label" for="is_online">Online sastanak</label>
                </div>
              </div>
            </div>
          </div>
          
          <div class="form-group" id="meeting_link_group">
            <label for="meeting_link">Link za sastanak</label>
            <input type="url" class="form-control" id="meeting_link" name="meeting_link" placeholder="https://...">
          </div>
          
          <div class="form-group">
            <label for="contact_person">Kontakt osobe</label>
            <input type="text" class="form-control" id="contact_person" placeholder="Počnite da kucate ime kontakt osobe...">
            <div id="contact-tags-container"></div>
            <input type="hidden" id="contact_persons" name="contact_persons">
          </div>
          
          <div class="form-group">
            <label for="external_attendees">Eksterni učesnici</label>
            <textarea class="form-control" id="external_attendees" name="external_attendees" rows="2" placeholder="Ime, email, telefon (jedan po liniji)"></textarea>
          </div>
          
          <div class="form-group">
            <label for="status">Status</label>
            <select class="form-control" id="status" name="status" required>
              <option value="scheduled">Zakazano</option>
              <option value="completed">Završeno</option>
              <option value="cancelled">Otkazano</option>
              <option value="postponed">Odloženo</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="notes">Napomene</label>
            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" id="deleteAppointmentBtn">Obriši</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Otkaži</button>
          <button type="submit" class="btn btn-primary">Sačuvaj</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Appointment Detail Modal -->
<div class="modal fade" id="appointmentDetailModal" tabindex="-1" role="dialog" aria-labelledby="appointmentDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="appointmentDetailModalLabel">Detalji sastanka</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="appointmentDetailContent">
        <!-- Content will be loaded dynamically -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Zatvori</button>
        <button type="button" class="btn btn-primary" id="editAppointmentBtn">Izmeni</button>
      </div>
    </div>
  </div>
</div>

<!-- Audit Detail Modal -->
<div class="modal fade" id="auditDetailModal" tabindex="-1" role="dialog" aria-labelledby="auditDetailModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="auditDetailModalLabel">Detalji audita</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="auditDetailContent">
        <!-- Content will be loaded dynamically -->
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5 class="card-title">Osnovne informacije</h5>
              </div>
              <div class="card-body">
                <table class="table table-striped">
                  <tbody>
                    <tr>
                      <th>Kompanija:</th>
                      <td id="audit-company"></td>
                    </tr>
                    <tr>
                      <th>Tip audita:</th>
                      <td id="audit-type"></td>
                    </tr>
                    <tr>
                      <th>Status:</th>
                      <td id="audit-status"></td>
                    </tr>
                    <tr>
                      <th>Planirani datum:</th>
                      <td id="audit-planned-date"></td>
                    </tr>
                    <tr>
                      <th>Stvarni datum:</th>
                      <td id="audit-actual-date"></td>
                    </tr>
                    <tr>
                      <th>Broj dana audita:</th>
                      <td id="audit-days-count"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5 class="card-title">Dani audita</h5>
              </div>
              <div class="card-body">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Datum</th>
                      <th>Planirano</th>
                      <th>Održano</th>
                      <th>Napomene</th>
                    </tr>
                  </thead>
                  <tbody id="audit-days-table-body">
                    <!-- Audit days will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5 class="card-title">Napomene</h5>
              </div>
              <div class="card-body">
                <p id="audit-notes"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Zatvori</button>
        <button type="button" class="btn btn-primary" id="editAuditBtn">Izmeni</button>
      </div>
    </div>
  </div>
</div>

<!-- Cycle Audit Detail Modal -->
<div class="modal fade" id="cycleAuditModal" tabindex="-1" role="dialog" aria-labelledby="cycleAuditModalLabel">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cycleAuditModalLabel">Detalji certifikacionog ciklusa</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5 class="card-title">Osnovne informacije</h5>
              </div>
              <div class="card-body">
                <table class="table table-striped">
                  <tbody>
                    <tr>
                      <th>Kompanija:</th>
                      <td id="cycle-company"></td>
                    </tr>
                    <tr>
                      <th>Tip audita:</th>
                      <td id="cycle-audit-type"></td>
                    </tr>
                    <tr>
                      <th>Status:</th>
                      <td id="cycle-status"></td>
                    </tr>
                    <tr>
                      <th>Planirani datum:</th>
                      <td id="cycle-planned-date"></td>
                    </tr>
                    <tr>
                      <th>Stvarni datum:</th>
                      <td id="cycle-actual-date"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5 class="card-title">Informacije o ciklusu</h5>
              </div>
              <div class="card-body">
                <table class="table table-striped">
                  <tbody>
                    <tr>
                      <th>ID ciklusa:</th>
                      <td id="cycle-id"></td>
                    </tr>
                    <tr>
                      <th>Početak ciklusa:</th>
                      <td id="cycle-start-date"></td>
                    </tr>
                    <tr>
                      <th>Kraj ciklusa:</th>
                      <td id="cycle-end-date"></td>
                    </tr>
                    <tr>
                      <th>Status ciklusa:</th>
                      <td id="cycle-cycle-status"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5 class="card-title">Napomene</h5>
              </div>
              <div class="card-body">
                <p id="cycle-notes"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Zatvori</button>
        <button type="button" class="btn btn-primary" id="viewCycleBtn" onclick="var cycleId = document.getElementById('cycle-id').textContent; console.log('Cycle ID:', cycleId); console.log('Redirecting to:', '/company/cycles/' + cycleId + '/'); window.location.href = '/company/cycles/' + cycleId + '/'">Pregledaj ciklus</button>
        <button type="button" class="btn btn-success" id="editCycleAuditBtn">Izmeni audit</button>
      </div>
    </div>
  </div>
</div>

<!-- Audit Day Modal -->
<div class="modal fade" id="auditDayModal" tabindex="-1" role="dialog" aria-labelledby="auditDayModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="auditDayModalLabel">Dan Audita</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Osnovni podaci o auditu -->
        <div class="row mb-4">
          <div class="col-md-6">
            <h6 class="font-weight-bold">Podaci o auditu</h6>
            <div class="mb-2">
              <strong>Kompanija:</strong>
              <span id="audit-company">Učitavanje...</span>
            </div>
            <div class="mb-2">
              <strong>Tip audita:</strong>
              <span id="audit-type">Učitavanje...</span>
            </div>
            <div class="mb-2">
              <strong>Status audita:</strong>
              <span id="audit-status">Učitavanje...</span>
            </div>
          </div>
          <div class="col-md-6">
            <h6 class="font-weight-bold">Datumi</h6>
            <div class="mb-2">
              <strong>Planirani datum:</strong>
              <span id="audit-planned-date">Učitavanje...</span>
            </div>
            <div class="mb-2">
              <strong>Stvarni datum:</strong>
              <span id="audit-actual-date">Učitavanje...</span>
            </div>
          </div>
        </div>

        <!-- Podaci o danu audita -->
        <div class="row">
          <div class="col-12">
            <h6 class="font-weight-bold">Dan audita</h6>
            <div class="mb-2">
              <strong>Planirano:</strong>
              <span id="audit-day-is-planned">Učitavanje...</span>
            </div>
            <div class="mb-2">
              <strong>Realizovano:</strong>
              <span id="audit-day-is-actual">Učitavanje...</span>
            </div>
            <div class="mb-2">
              <strong>Napomene:</strong>
              <div id="audit-day-notes" class="mt-1">Učitavanje...</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Zatvori</button>
        <button type="button" class="btn btn-primary" id="editAuditDayBtn" disabled>Izmeni</button>
      </div>
    </div>
  </div>
</div>

<!-- Nastavak extra_scripts bloka -->
<!-- Učitavanje biblioteka sa provjerom grešaka -->
<script>
  // Funkcija za učitavanje skripte sa provjerom grešaka
  function loadScript(url, callback) {
    console.log('Učitavanje skripte: ' + url);
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = url;
    script.onload = function() {
      console.log('Uspješno učitana skripta: ' + url);
      if (callback) callback();
    };
    script.onerror = function() {
      console.error('Greška pri učitavanju skripte: ' + url);
    };
    document.head.appendChild(script);
  }

  // Sekvencijalno učitavanje skripti
  loadScript('https://code.jquery.com/jquery-3.6.0.min.js', function() {
    loadScript('https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js', function() {
      loadScript('https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js', function() {
        loadScript('https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js', function() {
          loadScript('https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@5.11.3/main.min.js', function() {
            loadScript('https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@5.11.3/main.min.js', function() {
              loadScript('https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@5.11.3/main.min.js', function() {
                loadScript('https://cdn.jsdelivr.net/npm/@fullcalendar/bootstrap@5.11.3/main.min.js', function() {
                  console.log('Sve skripte su učitane, inicijalizacija kalendara...');
                  initializeCalendar();
                });
              });
            });
          });
        });
      });
    });
  });
</script>
<!-- jQuery UI -->
<script src="{% static 'plugins/jquery-ui/jquery-ui.min.js' %}"></script>

<!-- Ensure Bootstrap JS is loaded for modals -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}

<!-- URLs for AJAX requests -->
<script>
  // Define URLs for the JavaScript file
  var eventsApiUrl = "{% url 'company:appointment_calendar_json' %}";
  var contactsApiUrl = "{% url 'company:get_company_contacts' %}";
  var appointmentCreateUrl = "{% url 'company:appointment_create' %}";
  var appointmentUpdateUrl = "/company/appointments/0/update/";
  var appointmentDeleteUrl = "/company/appointments/0/delete/";
  var appointmentDetailUrl = "/company/appointments/0/";
  var auditDetailUrl = "{% url 'company:audit_detail_json' 0 %}";
  var auditUpdateUrl = "{% url 'company:cycle_audit_update' 0 %}";
  // Base URL za certification_cycle_json koji će se koristiti sa dinamičkim ID-om
  var certificationCycleJsonBaseUrl = "/company/api/cycles/";
</script>

<!-- Custom Calendar JavaScript -->
<script src="{% static 'js/calendar.js' %}"></script>

<!-- Funkcija za inicijalizaciju kalendara -->
<script>
  // Funkcija za formatiranje datuma
  function formatDate(dateString) {
    if (!dateString) return 'Nije postavljen';
    
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return 'Neispravan datum';
    
    return date.toLocaleDateString('sr-RS', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    });
  }

  // Funkcija za proveru dostupnosti Bootstrap JS biblioteke
  function isBootstrapAvailable() {
    return (typeof $.fn.modal === 'function');
  }

  // Funkcija za sigurno otvaranje modala
  function safeShowModal(modalId) {
    if (!isBootstrapAvailable()) {
      console.error('Bootstrap JS nije dostupan! Učitavam ga...');
      
      // Pokušaj učitati Bootstrap JS
      var script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js';
      script.onload = function() {
        console.log('Bootstrap JS uspešno učitan!');  
        setTimeout(function() {
          try {
            $(modalId).modal('show');
          } catch (e) {
            console.error('Greška pri otvaranju modala nakon učitavanja Bootstrap JS:', e);
            alert('Greška pri otvaranju modala. Molimo osvježite stranicu i pokušajte ponovo.');
          }
        }, 500);
      };
      script.onerror = function() {
        console.error('Greška pri učitavanju Bootstrap JS!');
        alert('Greška pri učitavanju potrebnih biblioteka. Molimo osvježite stranicu i pokušajte ponovo.');
      };
      document.head.appendChild(script);
    } else {
      try {
        $(modalId).modal('show');
      } catch (e) {
        console.error('Greška pri otvaranju modala:', e);
        alert('Greška pri otvaranju modala. Molimo osvježite stranicu i pokušajte ponovo.');
      }
    }
  }
  
  // Funkcija za otvaranje modala za detalje audit dana
  function openAuditDayModal(event) {
    console.log('Opening audit day modal for event:', event);
    console.log('Event extended props:', event.extendedProps);
    
    try {
      // Prikaži modal sigurno
      safeShowModal('#auditDayModal');
      
      // Postavi učitavanje za sva polja
      $('#audit-day-date').text('Učitavanje...');
      $('#audit-day-is-planned').text('Učitavanje...');
      $('#audit-day-is-actual').text('Učitavanje...');
      $('#audit-day-notes').text('Učitavanje...');
      $('#audit-day-audit-id').text('Učitavanje...');
      
      // Dobavi podatke iz event objekta
      const eventProps = event.extendedProps || {};
      const auditId = eventProps.audit_id;
      
      console.log('Audit ID from event:', auditId);
      
      if (!auditId) {
        console.error('Nije pronađen ID audita u event objektu');
        $('#audit-day-date').text('Greška: Nije pronađen ID audita');
        return;
      }
      
      // Koristimo audit_id za dobavljanje audit_day_id preko AJAX-a
      const ajaxUrl = `/company/api/audit-days/by-audit/${auditId}/`;
      console.log('AJAX URL for audit day data:', ajaxUrl);
      
      $.ajax({
        url: ajaxUrl,
        dataType: 'json',
        timeout: 10000, // 10 sekundi timeout
        beforeSend: function() {
          console.log('Sending AJAX request for audit day data...');
        },
        success: function(data) {
          console.log('Audit day data received:', data);
          if (data && data.id) {
            const auditDayId = data.id;
            updateAuditDayModal(auditDayId, auditId, event, eventProps);
          } else {
            console.error('Nema ID-a audit dana u odgovoru');
            $('#audit-day-date').text('Greška: Nije pronađen ID audit dana u odgovoru');
          }
        },
        error: function(xhr, status, error) {
          console.error('Greška prilikom dohvatanja podataka o audit danu:', error);
          $('#audit-day-date').text('Greška pri dohvatanju podataka');
        }
      });
      
  // Funkcija za ažuriranje audit day modala nakon dobijanja ID-a
  function updateAuditDayModal(auditDayId, auditId, event, eventProps) {
    // Popuni osnovne podatke iz event objekta
    $('#audit-day-date').text(formatDate(event.start) || 'N/A');
    $('#audit-day-is-planned').text(eventProps.auditStatus === 'planned' ? 'Da' : 'Ne');
    $('#audit-day-is-actual').text(eventProps.auditStatus === 'completed' ? 'Da' : 'Ne');
    $('#audit-day-notes').text(eventProps.notes || 'Nema napomena');
    $('#audit-day-audit-id').text(auditId || 'N/A');
    
    // Postavi URL za dugme za pregled audita
    $('#viewAuditBtn').off('click').on('click', function() {
      if (auditId) {
        const auditUrl = `/company/audits/${auditId}/`;
        console.log('Navigating to audit URL:', auditUrl);
        window.location.href = auditUrl;
      } else {
        alert('ID audita nije dostupan.');
      }
    });
    
    // Postavi URL za dugme za izmenu audit dana
    $('#editAuditDayBtn').off('click').on('click', function() {
      if (auditDayId) {
        const auditDayUrl = `/company/audit-days/${auditDayId}/update/`;
        console.log('Navigating to audit day update URL:', auditDayUrl);
        window.location.href = auditDayUrl;
      } else {
        alert('ID audit dana nije dostupan.');
      }
    });
  }
    } catch (e) {
      console.error('Greška pri otvaranju AuditDay modala:', e);
    }
  }

  // Funkcija za otvaranje modala za detalje certifikacionog ciklusa
  function openCycleAuditModal(event) {
    console.log('Opening cycle audit modal for event:', event);
    console.log('Event extended props:', event.extendedProps);
    
    try {
      // Prikaži modal sigurno
      safeShowModal('#cycleAuditModal');
      
      // Postavi učitavanje za sva polja
      $('#cycle-company').text('Učitavanje...');
      $('#cycle-audit-type').text('Učitavanje...');
      $('#cycle-status').text('Učitavanje...');
      $('#cycle-planned-date').text('Učitavanje...');
      $('#cycle-actual-date').text('Učitavanje...');
      $('#cycle-id').text('Učitavanje...');
      $('#cycle-start-date').text('Učitavanje...');
      $('#cycle-end-date').text('Učitavanje...');
      $('#cycle-cycle-status').text('Učitavanje...');
      $('#cycle-notes').text('Učitavanje...');
      
      // Dobavi podatke iz event objekta
      const eventProps = event.extendedProps || {};
      const cycleId = eventProps.cycle_id;
      
      console.log('Cycle ID from event:', cycleId);
      console.log('Event ID:', event.id);
      
      if (!cycleId) {
        console.error('Nije pronađen ID ciklusa u event objektu');
        $('#cycle-company').text('Greška: Nije pronađen ID ciklusa');
        return;
      }
      
      // Popuni osnovne podatke iz event objekta
      $('#cycle-company').text(eventProps.company || 'N/A');
      $('#cycle-audit-type').text(eventProps.type || 'N/A');
      $('#cycle-status').text(eventProps.status || 'N/A');
      $('#cycle-id').text(cycleId || 'N/A');
      $('#cycle-notes').text(eventProps.notes || 'Nema napomena');
      
      // Postavi URL za dugme za pregled ciklusa
      $('#viewCycleBtn').off('click').on('click', function() {
        const cycleUrl = `/company/cycles/${cycleId}/`;
        console.log('Navigating to cycle URL:', cycleUrl);
        window.location.href = cycleUrl;
      });
      
      // Postavi URL za dugme za izmenu audita
      let auditId;
      try {
        auditId = event.id.split('_').pop();
        console.log('Extracted audit ID:', auditId);
      } catch (e) {
        console.error('Error extracting audit ID:', e);
        auditId = '';
      }
      
      $('#editCycleAuditBtn').off('click').on('click', function() {
        const auditUrl = `/company/audits/${auditId}/update/`;
        console.log('Navigating to audit update URL:', auditUrl);
        window.location.href = auditUrl;
      });
      
      // Proveri da li je URL za dohvatanje podataka o ciklusu dostupan
      if (!certificationCycleJsonUrl) {
        console.error('certificationCycleJsonUrl nije definisan');
        $('#cycle-start-date').text('Greška: URL nije dostupan');
        $('#cycle-end-date').text('Greška: URL nije dostupan');
        $('#cycle-cycle-status').text('Greška: URL nije dostupan');
        return;
      }
      
      const ajaxUrl = certificationCycleJsonUrl.replace('0', cycleId);
      console.log('AJAX URL for cycle data:', ajaxUrl);
      
      // Dohvati dodatne podatke o ciklusu preko AJAX-a
      $.ajax({
        url: ajaxUrl,
        dataType: 'json',
        timeout: 10000, // 10 sekundi timeout
        beforeSend: function() {
          console.log('Sending AJAX request for cycle data...');
        },
        success: function(data) {
          console.log('Cycle data received:', data);
          
          if (data && data.cycle) {
            try {
              // Popuni podatke o ciklusu
              $('#cycle-start-date').text(formatDate(data.cycle.start_date));
              $('#cycle-end-date').text(formatDate(data.cycle.end_date));
              
              // Proveri da li postoji status_display, ako ne, koristi status direktno
              if (data.cycle.status_display) {
                $('#cycle-cycle-status').text(data.cycle.status_display);
              } else if (data.cycle.status) {
                // Mapiraj status na čitljiv tekst
                const statusMap = {
                  'active': 'Aktivan',
                  'completed': 'Završen',
                  'cancelled': 'Otkazan'
                };
                $('#cycle-cycle-status').text(statusMap[data.cycle.status] || data.cycle.status);
              } else {
                $('#cycle-cycle-status').text('N/A');
              }
              
              // Popuni podatke o auditu
              if (data.audit) {
                $('#cycle-planned-date').text(formatDate(data.audit.planned_date) || 'Nije postavljen');
                $('#cycle-actual-date').text(formatDate(data.audit.actual_date) || 'Nije postavljen');
              } else {
                console.warn('Nema podataka o auditu u odgovoru');
                $('#cycle-planned-date').text('Nije dostupno');
                $('#cycle-actual-date').text('Nije dostupno');
              }
            } catch (e) {
              console.error('Greška pri popunjavanju podataka o ciklusu:', e);
              $('#cycle-start-date').text('Greška pri obradi podataka');
              $('#cycle-end-date').text('Greška pri obradi podataka');
              $('#cycle-cycle-status').text('Greška pri obradi podataka');
            }
          } else {
            console.error('Nema podataka o ciklusu u odgovoru');
            $('#cycle-start-date').text('Nije dostupno');
            $('#cycle-end-date').text('Nije dostupno');
            $('#cycle-cycle-status').text('Nije dostupno');
          }
        },
        error: function(xhr, status, error) {
          console.error('Greška prilikom dohvatanja podataka o ciklusu:', error);
          console.error('Status:', status);
          console.error('Response text:', xhr.responseText);
          
          let errorMsg = 'Greška prilikom dohvatanja podataka';
          
          try {
            const response = JSON.parse(xhr.responseText);
            if (response && response.error) {
              errorMsg = response.error;
            }
          } catch (e) {
            console.error('Greška prilikom parsiranja odgovora:', e);
          }
          
          $('#cycle-start-date').text('Greška');
          $('#cycle-end-date').text('Greška');
          $('#cycle-cycle-status').text('Greška');
          alert('Greška prilikom dohvatanja podataka o ciklusu: ' + errorMsg);
        }
      });
    } catch (e) {
      console.error('Greška pri otvaranju CycleAudit modala:', e);
    }
  }

  // Funkcija za otvaranje modala za detalje termina
  function openAppointmentModal(event) {
    console.log('Opening appointment modal for event:', event);
    console.log('Event extended props:', event.extendedProps);
    
    try {
      // Prikaži modal sigurno
      safeShowModal('#appointmentDetailModal');
      
      // Postavi učitavanje za sva polja
      $('#appointment-title').text('Učitavanje...');
      $('#appointment-company').text('Učitavanje...');
      $('#appointment-start').text('Učitavanje...');
      $('#appointment-end').text('Učitavanje...');
      $('#appointment-location').text('Učitavanje...');
      $('#appointment-description').text('Učitavanje...');
      $('#appointment-contacts').text('Učitavanje...');
      
      // Dobavi podatke iz event objekta
      const eventProps = event.extendedProps || {};
      const appointmentId = eventProps.appointment_id;
      
      console.log('Appointment ID from event:', appointmentId);
      
      if (!appointmentId) {
        console.error('Nije pronađen ID termina u event objektu');
        $('#appointment-title').text('Greška: Nije pronađen ID termina');
        return;
      }
      
      // Popuni osnovne podatke iz event objekta
      $('#appointment-title').text(event.title || 'N/A');
      $('#appointment-company').text(eventProps.company || 'N/A');
      $('#appointment-start').text(formatDate(event.start) + ' ' + event.start.toLocaleTimeString('sr-RS'));
      $('#appointment-end').text(formatDate(event.end) + ' ' + event.end.toLocaleTimeString('sr-RS'));
      $('#appointment-location').text(eventProps.location || 'Nije definisano');
      $('#appointment-description').text(eventProps.description || 'Nema opisa');
      $('#appointment-contacts').text(eventProps.contacts || 'Nema kontakata');
      
      // Postavi ID za edit dugme
      $('#editAppointmentBtn').data('id', appointmentId);
    } catch (e) {
      console.error('Greška pri otvaranju Appointment modala:', e);
    }
  }
  
  function openAuditDayModal(event) {
    try {
      // Detaljno logovanje event objekta
      console.log('Event objekat:', event);
      console.log('Event title:', event.title);
      console.log('Event start:', event.start);
      console.log('Event extendedProps:', event.extendedProps);
      console.log('Event backgroundColor:', event.backgroundColor);
      console.log('Event type:', event.extendedProps?.type);
      console.log('Otvaranje audit day modala:', event);
      
      // Prikaži modal sigurno
      safeShowModal('#auditDetailModal');
      
      // Dobavi podatke iz event objekta
      const eventProps = event.extendedProps || {};
      const auditDayId = eventProps.audit_day_id;
      
      console.log('Audit Day ID:', auditDayId);
      
      if (!auditDayId) {
        console.error('Nije pronađen ID audit dana u event objektu');
        return;
      }
      
      // Popuni osnovne podatke iz event objekta
      $('#audit-company').text(eventProps.company || 'N/A');
      $('#audit-type').text(eventProps.audit_type || 'N/A');
      $('#audit-status').text(eventProps.status || 'N/A');
      $('#audit-planned-date').text(formatDate(event.start) || 'Nije definisano');
      $('#audit-actual-date').text(eventProps.actual_date ? formatDate(new Date(eventProps.actual_date)) : 'Nije održano');
      $('#audit-days-count').text(eventProps.days_count || '0');
      $('#audit-notes').text(eventProps.notes || 'Nema napomena');
      
      // Popuni tabelu dana audita
      const auditDaysTableBody = $('#audit-days-table-body');
      auditDaysTableBody.empty();
      
      if (eventProps.audit_days && eventProps.audit_days.length > 0) {
        eventProps.audit_days.forEach(day => {
          const row = $('<tr>');
          row.append($('<td>').text(formatDate(new Date(day.date))));
          row.append($('<td>').text(day.planned ? 'Da' : 'Ne'));
          row.append($('<td>').text(day.completed ? 'Da' : 'Ne'));
          row.append($('<td>').text(day.notes || '-'));
          auditDaysTableBody.append(row);
        });
      } else {
        auditDaysTableBody.append(
          $('<tr>').append(
            $('<td colspan="4" class="text-center">').text('Nema podataka o danima audita')
          )
        );
      }
      
      // Postavi ID za edit dugme
      $('#editAuditBtn').data('id', auditDayId);
    } catch (e) {
      console.error('Greška pri otvaranju Audit Day modala:', e);
    }
  }

  function initializeCalendar() {
    console.log('Pokretanje inicijalizacije kalendara...');
    
    // Provera da li je jQuery dostupan
    if (typeof jQuery === 'undefined') {
      console.error('jQuery nije dostupan!');
      return;
    }
    
    // Provera da li je FullCalendar dostupan
    if (typeof FullCalendar === 'undefined') {
      console.error('FullCalendar nije dostupan!');
      return;
    }
    
    // Provera da li postoji element kalendara
    var calendarEl = document.getElementById('calendar');
    if (!calendarEl) {
      console.error('Element kalendara ne postoji!');
      return;
    }
    
    console.log('Inicijalizacija kalendara...');
    
    // Inicijalizacija kalendara
    try {
      var calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'sr',
        initialView: 'dayGridMonth',
        height: 'auto',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        themeSystem: 'bootstrap',
        events: eventsApiUrl,
        eventClick: function(info) {
          // Provera tipa događaja i otvaranje odgovarajućeg modala
          var eventType = info.event.extendedProps.eventType;
          console.log('Kliknuto na događaj tipa:', eventType);
          
          if (eventType === 'audit_day') {
            openAuditDayModal(info.event);
          } else if (eventType === 'cycle_audit') {
            openCycleAuditModal(info.event);
          } else if (eventType === 'appointment') {
            openAppointmentModal(info.event);
          }
        }
      });
      
      calendar.render();
      console.log('Kalendar je uspešno inicijalizovan!');
    } catch (error) {
      console.error('Greška prilikom inicijalizacije kalendara:', error);
    }
  }
</script>
{% endblock %}
