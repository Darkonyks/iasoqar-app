{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Korisnički profil{% endblock %}

{% block extrastyle %}
<!-- Specific CSS for Profile -->
<link rel="stylesheet" href="{% static 'css/accounts/profile.css' %}">
{{ block.super }}
{% endblock %}

{% block content %}
<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
  <!-- Content Header (Page header) -->
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1>Korisnički profil</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="{% url 'company:dashboard' %}">Početna</a></li>
            <li class="breadcrumb-item active">Korisnički profil</li>
          </ol>
        </div>
      </div>
    </div><!-- /.container-fluid -->
  </section>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      {% if messages %}
      <div class="row">
        <div class="col-12">
          {% for message in messages %}
          <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show">
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            {% if message.tags == 'error' %}<i class="fas fa-exclamation-circle"></i>{% endif %}
            {% if message.tags == 'success' %}<i class="fas fa-check-circle"></i>{% endif %}
            {{ message }}
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
      <div class="row">
        <div class="col-md-3">

          <!-- Profile Image -->
          <div class="card card-primary card-outline">
            <div class="card-body box-profile">
              <div class="text-center">
                <i class="fas fa-user-circle fa-4x text-primary"></i>
              </div>

              <h3 class="profile-username text-center">{{ user.get_full_name|default:user.username }}</h3>

              <p class="text-muted text-center">{{ user.email }}</p>

              <ul class="list-group list-group-unbordered mb-3">
                <li class="list-group-item">
                  <b>Korisničko ime</b> <a class="float-right">{{ user.username }}</a>
                </li>
                <li class="list-group-item">
                  <b>Član od</b> <a class="float-right">{{ user.date_joined|date:"d.m.Y" }}</a>
                </li>
              </ul>
            </div>
            <!-- /.card-body -->
          </div>
          <!-- /.card -->
        </div>
        <!-- /.col -->
        <div class="col-md-9">
          <div class="card">
            <div class="card-header p-2">
              <ul class="nav nav-pills">
                <li class="nav-item"><a class="nav-link{% if not password_form.errors %} active{% endif %}" href="#settings" data-toggle="tab">Podešavanja</a></li>
                <li class="nav-item"><a class="nav-link{% if password_form.errors %} active{% endif %}" href="#password" data-toggle="tab">Promena lozinke</a></li>
              </ul>
            </div><!-- /.card-header -->
            <div class="card-body">
              <div class="tab-content">
                <div class="tab-pane{% if not password_form.errors %} active{% endif %}" id="settings">
                  <form class="form-horizontal" method="post" action="{% url 'accounts:profile' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_profile">
                    
                    <h5 class="mb-3"><i class="fas fa-user"></i> Osnovni podaci</h5>
                    <div class="form-group row">
                      <label for="id_first_name" class="col-sm-2 col-form-label">Ime</label>
                      <div class="col-sm-10">
                        {{ user_form.first_name }}
                        {% if user_form.first_name.errors %}
                          <span class="text-danger">{{ user_form.first_name.errors.0 }}</span>
                        {% endif %}
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="id_last_name" class="col-sm-2 col-form-label">Prezime</label>
                      <div class="col-sm-10">
                        {{ user_form.last_name }}
                        {% if user_form.last_name.errors %}
                          <span class="text-danger">{{ user_form.last_name.errors.0 }}</span>
                        {% endif %}
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="id_email" class="col-sm-2 col-form-label">Email</label>
                      <div class="col-sm-10">
                        {{ user_form.email }}
                        {% if user_form.email.errors %}
                          <span class="text-danger">{{ user_form.email.errors.0 }}</span>
                        {% endif %}
                      </div>
                    </div>
                    
                    <hr>
                    <h5 class="mb-3"><i class="fas fa-phone"></i> Kontakt informacije</h5>
                    <div class="form-group row">
                      <label for="id_phone" class="col-sm-2 col-form-label">Telefon</label>
                      <div class="col-sm-10">
                        {{ profile_form.phone }}
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="id_mobile" class="col-sm-2 col-form-label">Mobilni</label>
                      <div class="col-sm-10">
                        {{ profile_form.mobile }}
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="id_address" class="col-sm-2 col-form-label">Adresa</label>
                      <div class="col-sm-10">
                        {{ profile_form.address }}
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="id_city" class="col-sm-2 col-form-label">Grad</label>
                      <div class="col-sm-4">
                        {{ profile_form.city }}
                      </div>
                      <label for="id_postal_code" class="col-sm-2 col-form-label">Poš. broj</label>
                      <div class="col-sm-4">
                        {{ profile_form.postal_code }}
                      </div>
                    </div>
                    
                    <hr>
                    <h5 class="mb-3"><i class="fas fa-briefcase"></i> Poslovne informacije</h5>
                    <div class="form-group row">
                      <label for="id_business_number" class="col-sm-2 col-form-label">Poslovni broj</label>
                      <div class="col-sm-10">
                        {{ profile_form.business_number }}
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="id_department" class="col-sm-2 col-form-label">Odeljenje</label>
                      <div class="col-sm-10">
                        {{ profile_form.department }}
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="id_position" class="col-sm-2 col-form-label">Pozicija</label>
                      <div class="col-sm-10">
                        {{ profile_form.position }}
                      </div>
                    </div>
                    
                    <hr>
                    <h5 class="mb-3"><i class="fas fa-sticky-note"></i> Napomena</h5>
                    <div class="form-group row">
                      <label for="id_notes" class="col-sm-2 col-form-label">Napomena</label>
                      <div class="col-sm-10">
                        {{ profile_form.notes }}
                      </div>
                    </div>
                    
                    <div class="form-group row">
                      <div class="offset-sm-2 col-sm-10">
                        <button type="submit" class="btn btn-primary">
                          <i class="fas fa-save"></i> Sačuvaj izmene
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
                <!-- /.tab-pane -->
                <div class="tab-pane{% if password_form.errors %} active show{% endif %}" id="password">
                  <form class="form-horizontal" method="post" action="{% url 'accounts:profile' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="change_password">
                    
                    {% if password_form.errors %}
                    <div class="alert alert-danger">
                      <i class="fas fa-exclamation-triangle"></i> <strong>Greška pri promeni lozinke:</strong>
                      <ul class="mb-0 mt-2">
                        {% for field in password_form %}
                          {% for error in field.errors %}
                            <li>{{ field.label }}: {{ error }}</li>
                          {% endfor %}
                        {% endfor %}
                        {% for error in password_form.non_field_errors %}
                          <li>{{ error }}</li>
                        {% endfor %}
                      </ul>
                    </div>
                    {% endif %}
                    
                    <div class="form-group row">
                      <label for="id_old_password" class="col-sm-3 col-form-label">Trenutna lozinka</label>
                      <div class="col-sm-9">
                        {{ password_form.old_password }}
                        {% if password_form.old_password.errors %}
                          <span class="text-danger">{{ password_form.old_password.errors.0 }}</span>
                        {% endif %}
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="id_new_password1" class="col-sm-3 col-form-label">Nova lozinka</label>
                      <div class="col-sm-9">
                        {{ password_form.new_password1 }}
                        {% if password_form.new_password1.errors %}
                          <span class="text-danger">{{ password_form.new_password1.errors.0 }}</span>
                        {% endif %}
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="id_new_password2" class="col-sm-3 col-form-label">Potvrda lozinke</label>
                      <div class="col-sm-9">
                        {{ password_form.new_password2 }}
                        {% if password_form.new_password2.errors %}
                          <span class="text-danger">{{ password_form.new_password2.errors.0 }}</span>
                        {% endif %}
                      </div>
                    </div>
                    <div class="form-group row">
                      <div class="offset-sm-3 col-sm-9">
                        <button type="submit" class="btn btn-warning">
                          <i class="fas fa-key"></i> Promeni lozinku
                        </button>
                      </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                      <i class="fas fa-info-circle"></i> 
                      Lozinka mora imati najmanje 8 karaktera i ne sme biti previše jednostavna.
                    </div>
                  </form>
                </div>
                <!-- /.tab-pane -->
              </div>
              <!-- /.tab-content -->
            </div><!-- /.card-body -->
          </div>
          <!-- /.card -->
        </div>
        <!-- /.col -->
      </div>
      <!-- /.row -->
    </div><!-- /.container-fluid -->
  </section>
  <!-- /.content -->
</div>
<!-- /.content-wrapper -->
{% endblock %}

{% block extra_scripts %}
<!-- Specific JS for Profile -->
<script>
(function($) {
    'use strict';
    
    // Inicijalizacija kada je dokument spreman
    $(document).ready(function() {
        console.log('Inicijalizacija profile stranice...');
        
        // Inicijalizacija tabova
        initTabs();
        
        // Validacija forme za podešavanja
        $('#settings form').on('submit', function(e) {
            // Ovde možemo dodati dodatnu validaciju ako je potrebno
            return true;
        });
        
        // Validacija forme za promenu lozinke
        $('#password form').on('submit', function(e) {
            var currentPassword = $('#currentPassword').val();
            var newPassword = $('#newPassword').val();
            var confirmPassword = $('#confirmPassword').val();
            
            // Validacija polja
            if (!currentPassword || !newPassword || !confirmPassword) {
                e.preventDefault();
                showValidationError('Molimo popunite sva polja.');
                return false;
            }
            
            // Validacija lozinki
            if (newPassword !== confirmPassword) {
                e.preventDefault();
                showValidationError('Nova lozinka i potvrda lozinke se ne podudaraju.');
                return false;
            }
            
            return true;
        });
    });
    
    // Inicijalizacija tabova
    function initTabs() {
        // Zapamti aktivni tab između sesija
        var activeTab = localStorage.getItem('profileActiveTab');
        if (activeTab) {
            $('.nav-pills a[href="' + activeTab + '"]').tab('show');
        }
        
        // Postavi event listener za promenu taba
        $('.nav-pills a').on('shown.bs.tab', function(e) {
            var target = $(e.target).attr('href');
            localStorage.setItem('profileActiveTab', target);
        });
    }
    
    // Funkcija za prikazivanje grešaka validacije
    function showValidationError(message) {
        // Proveri da li već postoji poruka o grešci
        if ($('.alert-danger').length) {
            $('.alert-danger').html(message);
        } else {
            // Kreiraj novi element za poruku
            var alert = $('<div class="alert alert-danger alert-dismissible">' +
                          '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
                          message +
                          '</div>');
            
            // Dodaj poruku na početak aktivne forme
            $('.tab-pane.active form').prepend(alert);
        }
    }
    
})(jQuery);
</script>
{% endblock %}
