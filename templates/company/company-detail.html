{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{{ company.name }} - Detalji{% endblock %}

{% block extrastyle %}
<link rel="stylesheet" href="{% static 'css/company/company-detail.css' %}">
{% endblock %}

{% block extrajs %}
<script src="{% static 'js/company/company-detail.js' %}"></script>
<script src="{% static 'plugins/select2/js/select2.full.min.js' %}"></script>
<script>
  $(document).ready(function() {
    // Initialize Select2 Elements
    $('.select2').select2({
      theme: 'bootstrap4'
    });
  });
</script>
{% endblock %}

{% block content %}
{% now "Y-m-d" as today %}
<div class="content-wrapper">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0">{{ company.name }}</h1>
        </div>
        <div class="col-sm-6">
          <div class="float-sm-right">
            <a href="{% url 'company:update' company.id %}" class="btn btn-primary">
              <i class="fas fa-edit"></i> Izmeni
            </a>
            <a href="{% url 'company:delete' company.id %}" class="btn btn-danger">
              <i class="fas fa-trash"></i> Obriši
            </a>
            <a href="{% url 'company:list' %}" class="btn btn-secondary">
              <i class="fas fa-arrow-left"></i> Nazad na listu
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="content">
    <div class="container-fluid">
      <!-- Tabs Navigation -->
      <div class="row">
        <div class="col-12">
          <ul class="nav nav-tabs company-tabs" id="companyTabs" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" id="info-tab" data-toggle="tab" href="#info" role="tab">
                <i class="fas fa-info-circle mr-1"></i> Osnovni Podaci
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="standards-tab" data-toggle="tab" href="#standards" role="tab">
                <i class="fas fa-certificate mr-1"></i> Standardi i Sertifikati
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="iaf-eac-tab" data-toggle="tab" href="#iaf-eac" role="tab">
                <i class="fas fa-tags mr-1"></i> IAF/EAC Kodovi
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="contacts-tab" data-toggle="tab" href="#contacts" role="tab">
                <i class="fas fa-address-book mr-1"></i> Kontakti
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="locations-tab" data-toggle="tab" href="#locations" role="tab">
                <i class="fas fa-map-marker-alt mr-1"></i> Lokacije
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="audits-tab" data-toggle="tab" href="#audits" role="tab">
                <i class="fas fa-clipboard-check mr-1"></i> Provere i Auditi
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="meetings-tab" data-toggle="tab" href="#meetings" role="tab">
                <i class="fas fa-calendar-alt mr-1"></i> Sastanci
              </a>
            </li>

          </ul>
        </div>
      </div>
      
      <!-- Tab Content -->
      <div class="tab-content" id="companyTabsContent">
        <!-- Osnovni Podaci Tab -->
        <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
          <div class="row">
            <!-- Osnovne informacije -->
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Osnovne informacije</h3>
                </div>
                <div class="card-body">
                  <table class="info-table">
                    <tbody>
                      <tr>
                        <td>PIB:</td>
                        <td>{{ company.pib }}</td>
                      </tr>
                      <tr>
                        <td>Matični broj:</td>
                        <td>{{ company.mb }}</td>
                      </tr>
                      <tr>
                        <td>Adresa:</td>
                        <td>{{ company.street }} {{ company.street_number }}, {{ company.city }}, {{ company.postal_code }}</td>
                      </tr>
                      <tr>
                        <td>Telefon:</td>
                        <td>{{ company.phone|default:"Nije unet" }}</td>
                      </tr>
                      <tr>
                        <td>Email:</td>
                        <td>{{ company.email|default:"Nije unet" }}</td>
                      </tr>
                      <tr>
                        <td>Website:</td>
                        <td>{% if company.website %}<a href="{{ company.website }}" target="_blank">{{ company.website }}</a>{% else %}Nije unet{% endif %}</td>
                      </tr>
                      <tr>
                        <td>Industrija:</td>
                        <td>{{ company.get_industry_display }}</td>
                      </tr>
                      <tr>
                        <td>Status sertifikata:</td>
                        <td><span class="status-badge status-{{ company.certificate_status }}">{{ company.get_certificate_status_display }}</span></td>
                      </tr>
                      <tr>
                        <td>Broj sertifikata:</td>
                        <td>{% if company.certificate_number %}{{ company.certificate_number }}{% else %}<span class="text-muted">Nije unet</span>{% endif %}</td>
                      </tr>
                      <tr>
                        <td>Broj zaposlenih:</td>
                        <td>{{ company.number_of_employees|default:"Nije unet" }}</td>
                      </tr>
                    </tbody>
                  </table>
            </div>
          </div>
        </div>
        
            <!-- Napomene i detalji -->
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Dodatni detalji</h3>
                </div>
                <div class="card-body">
                  <table class="info-table">
                    <tbody>
                      <tr>
                        <td>Oblast registracije:</td>
                        <td>{% if company.oblast_registracije %}{{ company.oblast_registracije }}{% else %}<span class="text-muted">Nije uneto</span>{% endif %}</td>
                      </tr>
                      <tr>
                        <td>Datum inicijalnog audita:</td>
                        <td>{% if company.initial_audit_conducted_date %}{{ company.initial_audit_conducted_date|date:"d.m.Y" }}{% else %}<span class="text-muted">Nije uneto</span>{% endif %}</td>
                      </tr>
                      <tr>
                        <td>Broj poseta godišnje:</td>
                        <td>{% if company.visits_per_year %}{{ company.visits_per_year }}{% else %}<span class="text-muted">Nije uneto</span>{% endif %}</td>
                      </tr>
                      <tr>
                        <td>Broj dana po auditu:</td>
                        <td>{% if company.audit_days_each %}{{ company.audit_days_each }}{% else %}<span class="text-muted">Nije uneto</span>{% endif %}</td>
                      </tr>
                      <tr>
                        <td>Napomene:</td>
                        <td>{% if company.notes %}{{ company.notes|linebreaks }}{% else %}<span class="text-muted">Nema napomena</span>{% endif %}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Standardi i Sertifikati Tab -->
        <div class="tab-pane fade" id="standards" role="tabpanel" aria-labelledby="standards-tab">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Standardi</h3>
                </div>
                <div class="card-body">
                  {% if standards %}
                    <div class="table-responsive">
                      <table class="table table-striped">
                        <thead>
                          <tr>
                            <th>Standard</th>
                            <th>Status</th>
                            <th>Datum izdavanja</th>
                            <th>Datum isteka</th>
                            <th>Auditori</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for standard_item in standards %}
                            <tr>
                              <td>{{ standard_item.standard.standard_definition.standard }}</td>
                              <td><span class="status-badge status-active">Aktivan</span></td>
                              <td>{% if standard_item.standard.issue_date %}{{ standard_item.standard.issue_date|date:"d.m.Y" }}{% else %}-{% endif %}</td>
                              <td>{% if standard_item.standard.expiry_date %}{{ standard_item.standard.expiry_date|date:"d.m.Y" }}{% else %}-{% endif %}</td>
                              <td>
                                {% if standard_item.auditors %}
                                  <ul class="list-unstyled mb-0">
                                    {% for auditor in standard_item.auditors %}
                                      <li>
                                        <a href="{% url 'company:auditor_detail' pk=auditor.id %}" class="text-primary">
                                          <i class="fas fa-user-tie mr-1"></i> {{ auditor.ime_prezime }}
                                          {% if auditor.kategorija %}
                                            {% if auditor.kategorija == 'lead_auditor' %}
                                              <span class="badge badge-success">{{ auditor.get_kategorija_display }}</span>
                                            {% elif auditor.kategorija == 'auditor' %}
                                              <span class="badge badge-primary">{{ auditor.get_kategorija_display }}</span>
                                            {% elif auditor.kategorija == 'technical_expert' %}
                                              <span class="badge badge-secondary">{{ auditor.get_kategorija_display }}</span>
                                            {% elif auditor.kategorija == 'trainer' %}
                                              <span class="badge badge-info">{{ auditor.get_kategorija_display }}</span>
                                            {% endif %}
                                          {% endif %}
                                        </a>
                                      </li>
                                    {% endfor %}
                                  </ul>
                                {% else %}
                                  <span class="text-muted">Nema dodeljenih auditora</span>
                                {% endif %}
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <p class="text-muted">Nema dodeljenih standarda</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      
        <!-- IAF/EAC Kodovi Tab -->
        <div class="tab-pane fade" id="iaf-eac" role="tabpanel" aria-labelledby="iaf-eac-tab">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">IAF/EAC Kodovi</h3>
                </div>
                <div class="card-body">
                  {% if iaf_eac_codes %}
                    <div class="table-responsive">
                      <table class="table table-striped">
                        <thead>
                          <tr>
                            <th>IAF/EAC kod</th>
                            <th>Opis</th>
                            <th>Status</th>
                            <th>Napomena</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for code in iaf_eac_codes %}
                            <tr class="iaf-eac-code-item" data-code-id="{{ code.id }}" data-code="{{ code.iaf_eac_code.iaf_code }}" data-description="{{ code.iaf_eac_code.description }}" data-primary="{{ code.is_primary }}" data-notes="{{ code.notes }}">
                              <td>{{ code.iaf_eac_code.iaf_code }}</td>
                              <td>{{ code.iaf_eac_code.description }}</td>
                              <td>
                                {% if code.is_primary %}
                                  <span class="badge badge-primary">Primarni</span>
                                {% else %}
                                  <span class="badge badge-secondary">Sekundarni</span>
                                {% endif %}
                              </td>
                              <td>{{ code.notes|default:"-" }}</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <p class="text-muted">Nema dodeljenih IAF/EAC kodova</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Kontakti Tab -->
        <div class="tab-pane fade" id="contacts" role="tabpanel" aria-labelledby="contacts-tab">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Kontakt osobe</h3>
                </div>
                <div class="card-body">
                  {% if contact_persons %}
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>Ime i prezime</th>
                          <th>Pozicija</th>
                          <th>Email</th>
                          <th>Telefon</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for contact in contact_persons %}
                          <tr {% if contact.is_primary %} class="table-primary"{% endif %}>
                            <td><strong>{{ contact.ime_prezime }}</strong></td>
                            <td>{{ contact.pozicija|default:"-" }}</td>
                            <td>{% if contact.email %}<a href="mailto:{{ contact.email }}">{{ contact.email }}</a>{% else %}-{% endif %}</td>
                            <td>{{ contact.telefon|default:"-" }}</td>
                            <td>{% if contact.is_primary %}<span class="badge badge-primary">Primarni kontakt</span>{% endif %}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  {% else %}
                    <p class="text-muted">Nema kontakt osoba</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      
        <!-- Lokacije Tab -->
        <div class="tab-pane fade" id="locations" role="tabpanel" aria-labelledby="locations-tab">
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Glavna lokacija</h3>
                </div>
                <div class="card-body">
                  <table class="info-table">
                    <tbody>
                      <tr>
                        <td>Naziv:</td>
                        <td><strong>{{ company.name }}</strong> (Glavna lokacija)</td>
                      </tr>
                      <tr>
                        <td>Adresa:</td>
                        <td>{{ company.street }} {{ company.street_number }}, {{ company.city }}, {{ company.postal_code }}</td>
                      </tr>
                      <tr>
                        <td>Telefon:</td>
                        <td>{{ company.phone|default:"Nije unet" }}</td>
                      </tr>
                      <tr>
                        <td>Email:</td>
                        <td>{{ company.email|default:"Nije unet" }}</td>
                      </tr>
                      <tr>
                        <td>Država:</td>
                        <td>{{ company.country|default:"Srbija" }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h3 class="card-title">Ostale lokacije</h3>
                  <div class="card-tools">
                    <a href="{% url 'company:location_create' %}?company={{ company.id }}" class="btn btn-primary btn-sm">
                      <i class="fas fa-plus"></i> Nova lokacija
                    </a>
                  </div>
                </div>
                <div class="card-body">
                  {% if locations %}
                    <div class="table-responsive">
                      <table class="table table-striped table-hover">
                        <thead class="thead-light">
                          <tr>
                            <th>Naziv</th>
                            <th>Adresa</th>
                            <th>Grad</th>
                            <th>Akcije</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for location in locations %}
                            <tr>
                              <td><strong>{{ location.name }}</strong></td>
                              <td>
                                {% if location.full_address %}
                                  {{ location.full_address }}
                                {% else %}
                                  <span class="text-muted">Nije uneto</span>
                                {% endif %}
                              </td>
                              <td>{{ location.city|default:"Nije uneto" }}</td>
                              <td>
                                <div class="btn-group">
                                  <a href="{% url 'company:location_detail' location.id %}" class="btn btn-info btn-sm" title="Detalji">
                                    <i class="fas fa-eye"></i>
                                  </a>
                                  <a href="{% url 'company:location_update' location.id %}" class="btn btn-warning btn-sm" title="Izmeni">
                                    <i class="fas fa-edit"></i>
                                  </a>
                                  <a href="{% url 'company:location_delete' location.id %}" class="btn btn-danger btn-sm" title="Obriši">
                                    <i class="fas fa-trash"></i>
                                  </a>
                                </div>
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <p class="text-muted">Nema dodatnih lokacija</p>
                    <a href="{% url 'company:location_create' %}?company={{ company.id }}" class="btn btn-primary btn-sm">
                      <i class="fas fa-plus"></i> Dodaj prvu lokaciju
                    </a>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      
        <!-- Ciklusi Sertifikacije Tab -->
        <div class="tab-pane fade" id="audits" role="tabpanel" aria-labelledby="audits-tab">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h3 class="card-title">Ciklusi Sertifikacije</h3>
                  <div class="card-tools">
                    <a href="{% url 'company:company_cycle_create' company.id %}" class="btn btn-primary btn-sm">
                      <i class="fas fa-plus"></i> Novi Ciklus Sertifikacije
                    </a>
                  </div>
                </div>
                <div class="card-body p-0">
                  {% if certification_cycles %}
                    <div class="table-responsive">
                      <table class="table table-hover">
                        <thead>
                          <tr>
                            <th>Period</th>
                            <th>Status</th>
                            <th>Standardi</th>
                            <th>Auditi</th>
                            <th>Akcije</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for cycle in certification_cycles %}
                            <tr {% if cycle.status == 'active' %}class="table-success"{% endif %}>
                              <td>
                                <strong>{{ cycle.start_date|date:"d.m.Y" }} - {{ cycle.end_date|date:"d.m.Y" }}</strong>
                              </td>
                              <td>
                                {% if cycle.status == 'active' %}
                                  <span class="badge badge-success">Aktivan</span>
                                {% elif cycle.status == 'planned' %}
                                  <span class="badge badge-info">Planiran</span>
                                {% elif cycle.status == 'completed' %}
                                  <span class="badge badge-secondary">Završen</span>
                                {% elif cycle.status == 'cancelled' %}
                                  <span class="badge badge-danger">Otkazan</span>
                                {% endif %}
                              </td>
                              <td>
                                {% for standard in cycle.cycle_standards.all %}
                                  <span class="badge badge-info">{{ standard.standard_definition.code }} {{ standard.standard_definition.name }}</span>
                                {% empty %}
                                  <span class="text-muted">Nema standarda</span>
                                {% endfor %}
                              </td>
                              <td>{{ cycle.audits.count }}</td>
                              <td>
                                <a href="{% url 'company:cycle_detail' cycle.id %}" class="btn btn-info btn-sm" title="Detalji">
                                  <i class="fas fa-eye"></i> Detalji
                                </a>
                              </td>
                            </tr>
                          {% empty %}
                            <tr>
                              <td colspan="5" class="text-center">Nema ciklusa sertifikacije za ovu kompaniju</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <div class="p-3">
                      <p class="text-muted">Nema ciklusa sertifikacije. Kreirajte prvi ciklus.</p>
                      <a href="{% url 'company:company_cycle_create' company.id %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i> Novi Ciklus Sertifikacije
                      </a>
                    </div>
                  {% endif %}
                </div>
              </div>
              
              <div class="card mt-4">
                <div class="card-header">
                  <h3 class="card-title">Naredne provere</h3>
                </div>
                <div class="card-body">
                  {% if audit_info %}
                    <table class="table table-bordered">
                      <thead class="thead-light">
                        <tr>
                          <th>Tip provere</th>
                          <th>Planirano</th>
                          <th>Održano</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td><strong>Prvi nadzor</strong></td>
                          <td>{% if audit_info.first_surv_due %}{{ audit_info.first_surv_due|date:"d.m.Y" }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                          <td>{% if audit_info.first_surv_cond %}{{ audit_info.first_surv_cond|date:"d.m.Y" }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                          <td>
                            {% if audit_info.first_surv_cond %}
                              <span class="badge badge-success">Završeno</span>
                            {% elif audit_info.first_surv_due and audit_info.first_surv_due < today %}
                              <span class="badge badge-danger">Isteklo</span>
                            {% elif audit_info.first_surv_due %}
                              <span class="badge badge-info">Zakazano</span>
                            {% else %}
                              <span class="badge badge-secondary">Nije zakazano</span>
                            {% endif %}
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Drugi nadzor</strong></td>
                          <td>{% if audit_info.second_surv_due %}{{ audit_info.second_surv_due|date:"d.m.Y" }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                          <td>{% if audit_info.second_surv_cond %}{{ audit_info.second_surv_cond|date:"d.m.Y" }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                          <td>
                            {% if audit_info.second_surv_cond %}
                              <span class="badge badge-success">Završeno</span>
                            {% elif audit_info.second_surv_due and audit_info.second_surv_due < today %}
                              <span class="badge badge-danger">Isteklo</span>
                            {% elif audit_info.second_surv_due %}
                              <span class="badge badge-info">Zakazano</span>
                            {% else %}
                              <span class="badge badge-secondary">Nije zakazano</span>
                            {% endif %}
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Resertifikacija</strong></td>
                          <td>{% if audit_info.trinial_audit_due %}{{ audit_info.trinial_audit_due|date:"d.m.Y" }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                          <td>{% if audit_info.trinial_audit_cond %}{{ audit_info.trinial_audit_cond|date:"d.m.Y" }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                          <td>
                            {% if audit_info.trinial_audit_cond %}
                              <span class="badge badge-success">Završeno</span>
                            {% elif audit_info.trinial_audit_due and audit_info.trinial_audit_due < today %}
                              <span class="badge badge-danger">Isteklo</span>
                            {% elif audit_info.trinial_audit_due %}
                              <span class="badge badge-info">Zakazano</span>
                            {% else %}
                              <span class="badge badge-secondary">Nije zakazano</span>
                            {% endif %}
                          </td>
                        </tr>
                      </tbody>
                    </table>
                    <div class="mt-3">
                      <span class="badge badge-{{ audit_info.get_status_color }} float-right">Ukupni status: {{ audit_info.get_status_display }}</span>
                    </div>
                  {% else %}
                    <p class="text-muted">Nema informacija o narednim proverama</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      
        <!-- Sastanci Tab -->
        <div class="tab-pane fade" id="meetings" role="tabpanel" aria-labelledby="meetings-tab">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Sastanci i Termini</h3>
                  <div class="card-tools">
                    <a href="{% url 'company:calendar' %}" class="btn btn-sm btn-primary">
                      <i class="fas fa-calendar"></i> Svi sastanci
                    </a>
                  </div>
                </div>
                <div class="card-body">
                  {% if appointments %}
                    <div class="table-responsive">
                      <table class="table table-striped">
                        <thead>
                          <tr>
                            <th>Naslov</th>
                            <th>Tip</th>
                            <th>Datum</th>
                            <th>Status</th>
                            <th>Akcije</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for appointment in appointments %}
                            <tr>
                              <td>{{ appointment.title }}</td>
                              <td>{{ appointment.get_appointment_type_display }}</td>
                              <td>{{ appointment.start_datetime|date:"d.m.Y H:i" }}</td>
                              <td><span class="badge badge-{{ appointment.get_status_color }}">{{ appointment.get_status_display }}</span></td>
                              <td>
                                <a href="#" class="btn btn-sm btn-info" title="Detalji">
                                  <i class="fas fa-eye"></i>
                                </a>
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <p class="text-muted">Nema zakazanih sastanaka</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        
      </div> <!-- kraj tab-content -->
    </div> <!-- kraj container-fluid -->
  </div> <!-- kraj content -->
</div> <!-- kraj content-wrapper -->

<!-- Modal za ciklus sertifikacije -->
{% if show_cycle_form %}
<div class="modal fade" id="cycleFormModal" tabindex="-1" role="dialog" aria-labelledby="cycleFormModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cycleFormModalLabel">
          {% if editing_cycle %}
            Izmena ciklusa sertifikacije
          {% else %}
            Novi ciklus sertifikacije
          {% endif %}
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form method="post" action="{% url 'company:detail' company.id %}">
        {% csrf_token %}
        <div class="modal-body">
          {% if editing_cycle %}
            <input type="hidden" name="cycle_id" value="{{ editing_cycle.id }}">
          {% endif %}
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="{{ cycle_form.start_date.id_for_label }}">Datum početka</label>
                {{ cycle_form.start_date }}
                {% if cycle_form.start_date.errors %}
                  <div class="text-danger">{{ cycle_form.start_date.errors }}</div>
                {% endif %}
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="{{ cycle_form.end_date.id_for_label }}">Datum završetka</label>
                {{ cycle_form.end_date }}
                {% if cycle_form.end_date.errors %}
                  <div class="text-danger">{{ cycle_form.end_date.errors }}</div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="{{ cycle_form.status.id_for_label }}">Status ciklusa</label>
                {{ cycle_form.status }}
                {% if cycle_form.status.errors %}
                  <div class="text-danger">{{ cycle_form.status.errors }}</div>
                {% endif %}
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check mt-4">
                {{ cycle_form.is_integrated_system }}
                <label class="form-check-label" for="{{ cycle_form.is_integrated_system.id_for_label }}">
                  Integrisani sistem
                </label>
                {% if cycle_form.is_integrated_system.errors %}
                  <div class="text-danger">{{ cycle_form.is_integrated_system.errors }}</div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="{{ cycle_form.standards.id_for_label }}">Standardi</label>
            {{ cycle_form.standards }}
            {% if cycle_form.standards.errors %}
              <div class="text-danger">{{ cycle_form.standards.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label for="{{ cycle_form.notes.id_for_label }}">Napomene</label>
            {{ cycle_form.notes }}
            {% if cycle_form.notes.errors %}
              <div class="text-danger">{{ cycle_form.notes.errors }}</div>
            {% endif %}
          </div>
          
          {{ cycle_form.company }}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Odustani</button>
          <button type="submit" name="submit_cycle_form" class="btn btn-primary">Sačuvaj</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  $(document).ready(function() {
    $('#cycleFormModal').modal('show');
    $('.select2').select2({
      theme: 'bootstrap4',
      width: '100%'
    });
  });
</script>
{% endif %}

<!-- Modal za audit -->
{% if show_audit_form %}
<div class="modal fade" id="auditFormModal" tabindex="-1" role="dialog" aria-labelledby="auditFormModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="auditFormModalLabel">
          {% if editing_audit %}
            Izmena audita
          {% else %}
            Novi audit
          {% endif %}
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form method="post" action="{% url 'company:detail' company.id %}">
        {% csrf_token %}
        <div class="modal-body">
          {% if editing_audit %}
            <input type="hidden" name="audit_id" value="{{ editing_audit.id }}">
          {% endif %}
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="{{ audit_form.audit_type.id_for_label }}">Tip audita</label>
                {{ audit_form.audit_type }}
                {% if audit_form.audit_type.errors %}
                  <div class="text-danger">{{ audit_form.audit_type.errors }}</div>
                {% endif %}
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="{{ audit_form.audit_status.id_for_label }}">Status audita</label>
                {{ audit_form.audit_status }}
                {% if audit_form.audit_status.errors %}
                  <div class="text-danger">{{ audit_form.audit_status.errors }}</div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-4">
              <div class="form-group">
                <label for="{{ audit_form.planned_date.id_for_label }}">Planirani datum</label>
                {{ audit_form.planned_date }}
                {% if audit_form.planned_date.errors %}
                  <div class="text-danger">{{ audit_form.planned_date.errors }}</div>
                {% endif %}
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label for="{{ audit_form.actual_date.id_for_label }}">Stvarni datum</label>
                {{ audit_form.actual_date }}
                {% if audit_form.actual_date.errors %}
                  <div class="text-danger">{{ audit_form.actual_date.errors }}</div>
                {% endif %}
              </div>
            </div>
            <!-- Polje za datum završetka je uklonjeno -->
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="{{ audit_form.lead_auditor.id_for_label }}">Vodeći auditor</label>
                {{ audit_form.lead_auditor }}
                {% if audit_form.lead_auditor.errors %}
                  <div class="text-danger">{{ audit_form.lead_auditor.errors }}</div>
                {% endif %}
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="{{ audit_form.report_number.id_for_label }}">Broj izveštaja</label>
                {{ audit_form.report_number }}
                {% if audit_form.report_number.errors %}
                  <div class="text-danger">{{ audit_form.report_number.errors }}</div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="{{ audit_form.audit_team.id_for_label }}">Tim auditora</label>
            {{ audit_form.audit_team }}
            {% if audit_form.audit_team.errors %}
              <div class="text-danger">{{ audit_form.audit_team.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label for="{{ audit_form.findings.id_for_label }}">Nalazi</label>
            {{ audit_form.findings }}
            {% if audit_form.findings.errors %}
              <div class="text-danger">{{ audit_form.findings.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label for="{{ audit_form.recommendations.id_for_label }}">Preporuke</label>
            {{ audit_form.recommendations }}
            {% if audit_form.recommendations.errors %}
              <div class="text-danger">{{ audit_form.recommendations.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label for="{{ audit_form.notes.id_for_label }}">Napomene</label>
            {{ audit_form.notes }}
            {% if audit_form.notes.errors %}
              <div class="text-danger">{{ audit_form.notes.errors }}</div>
            {% endif %}
          </div>
          
          {{ audit_form.certification_cycle }}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Odustani</button>
          <button type="submit" name="submit_audit_form" class="btn btn-primary">Sačuvaj</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  $(document).ready(function() {
    $('#auditFormModal').modal('show');
    $('.select2').select2({
      theme: 'bootstrap4',
      width: '100%'
    });
  });
</script>
{% endif %}

{% endblock %}
