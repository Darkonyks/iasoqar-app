{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{{ company.name }} - Detalji{% endblock %}

{% block extrastyle %}
<link rel="stylesheet" href="{% static 'css/company/company-detail.css' %}">
{% endblock %}

{% block extrajs %}
<script src="{% static 'js/company/company-detail.js' %}"></script>
{% endblock %}

{% block content %}
{% now "Y-m-d" as today %}
<div class="content-wrapper">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0">{{ company.name }}</h1>
        </div>
        <div class="col-sm-6">
          <div class="float-sm-right">
            <a href="{% url 'company:update' company.id %}" class="btn btn-primary">
              <i class="fas fa-edit"></i> Izmeni
            </a>
            <a href="{% url 'company:delete' company.id %}" class="btn btn-danger">
              <i class="fas fa-trash"></i> Obriši
            </a>
            <a href="{% url 'company:list' %}" class="btn btn-secondary">
              <i class="fas fa-arrow-left"></i> Nazad na listu
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="content">
    <div class="container-fluid">
      <!-- Tabs Navigation -->
      <div class="row">
        <div class="col-12">
          <ul class="nav nav-tabs company-tabs" id="companyTabs" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" id="info-tab" data-toggle="tab" href="#info" role="tab">
                <i class="fas fa-info-circle mr-1"></i> Osnovni Podaci
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="standards-tab" data-toggle="tab" href="#standards" role="tab">
                <i class="fas fa-certificate mr-1"></i> Standardi i Sertifikati
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="contacts-tab" data-toggle="tab" href="#contacts" role="tab">
                <i class="fas fa-address-book mr-1"></i> Kontakti
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="locations-tab" data-toggle="tab" href="#locations" role="tab">
                <i class="fas fa-map-marker-alt mr-1"></i> Lokacije
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="audits-tab" data-toggle="tab" href="#audits" role="tab">
                <i class="fas fa-clipboard-check mr-1"></i> Provere i Auditi
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="meetings-tab" data-toggle="tab" href="#meetings" role="tab">
                <i class="fas fa-calendar-alt mr-1"></i> Sastanci
              </a>
            </li>
          </ul>
        </div>
      </div>
      
      <!-- Tab Content -->
      <div class="tab-content" id="companyTabsContent">
        <!-- Osnovni Podaci Tab -->
        <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
          <div class="row">
            <!-- Osnovne informacije -->
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Osnovne informacije</h3>
                </div>
                <div class="card-body">
                  <table class="info-table">
                    <tbody>
                      <tr>
                        <td>PIB:</td>
                        <td>{{ company.pib }}</td>
                      </tr>
                      <tr>
                        <td>Matični broj:</td>
                        <td>{{ company.mb }}</td>
                      </tr>
                      <tr>
                        <td>Adresa:</td>
                        <td>{{ company.street }} {{ company.street_number }}, {{ company.city }}, {{ company.postal_code }}</td>
                      </tr>
                      <tr>
                        <td>Telefon:</td>
                        <td>{{ company.phone|default:"Nije unet" }}</td>
                      </tr>
                      <tr>
                        <td>Email:</td>
                        <td>{{ company.email|default:"Nije unet" }}</td>
                      </tr>
                      <tr>
                        <td>Website:</td>
                        <td>{% if company.website %}<a href="{{ company.website }}" target="_blank">{{ company.website }}</a>{% else %}Nije unet{% endif %}</td>
                      </tr>
                      <tr>
                        <td>Industrija:</td>
                        <td>{{ company.get_industry_display }}</td>
                      </tr>
                      <tr>
                        <td>Status sertifikata:</td>
                        <td><span class="status-badge status-{{ company.certificate_status }}">{{ company.get_certificate_status_display }}</span></td>
                      </tr>
                      <tr>
                        <td>Broj sertifikata:</td>
                        <td>{% if company.certificate_number %}{{ company.certificate_number }}{% else %}<span class="text-muted">Nije unet</span>{% endif %}</td>
                      </tr>
                      <tr>
                        <td>Broj zaposlenih:</td>
                        <td>{{ company.number_of_employees|default:"Nije unet" }}</td>
                      </tr>
                    </tbody>
                  </table>
            </div>
          </div>
        </div>
        
            <!-- Napomene i detalji -->
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Dodatni detalji</h3>
                </div>
                <div class="card-body">
                  <table class="info-table">
                    <tbody>
                      <tr>
                        <td>Oblast registracije:</td>
                        <td>{% if company.oblast_registracije %}{{ company.oblast_registracije }}{% else %}<span class="text-muted">Nije uneto</span>{% endif %}</td>
                      </tr>
                      <tr>
                        <td>Datum inicijalnog audita:</td>
                        <td>{% if company.initial_audit_conducted_date %}{{ company.initial_audit_conducted_date|date:"d.m.Y" }}{% else %}<span class="text-muted">Nije uneto</span>{% endif %}</td>
                      </tr>
                      <tr>
                        <td>Broj poseta godišnje:</td>
                        <td>{% if company.visits_per_year %}{{ company.visits_per_year }}{% else %}<span class="text-muted">Nije uneto</span>{% endif %}</td>
                      </tr>
                      <tr>
                        <td>Broj dana po auditu:</td>
                        <td>{% if company.audit_days_each %}{{ company.audit_days_each }}{% else %}<span class="text-muted">Nije uneto</span>{% endif %}</td>
                      </tr>
                      <tr>
                        <td>Napomene:</td>
                        <td>{% if company.notes %}{{ company.notes|linebreaks }}{% else %}<span class="text-muted">Nema napomena</span>{% endif %}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Standardi i Sertifikati Tab -->
        <div class="tab-pane fade" id="standards" role="tabpanel" aria-labelledby="standards-tab">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Standardi</h3>
                </div>
                <div class="card-body">
                  {% if standards %}
                    <div class="table-responsive">
                      <table class="table table-striped">
                        <thead>
                          <tr>
                            <th>Standard</th>
                            <th>Status</th>
                            <th>Datum izdavanja</th>
                            <th>Datum isteka</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for company_standard in standards %}
                            <tr>
                              <td>{{ company_standard.standard_definition.standard }}</td>
                              <td><span class="status-badge status-active">Aktivan</span></td>
                              <td>{% if company_standard.issue_date %}{{ company_standard.issue_date|date:"d.m.Y" }}{% else %}-{% endif %}</td>
                              <td>{% if company_standard.expiry_date %}{{ company_standard.expiry_date|date:"d.m.Y" }}{% else %}-{% endif %}</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <p class="text-muted">Nema dodeljenih standarda</p>
                  {% endif %}
                </div>
              </div>
              
              <div class="card mt-4">
                <div class="card-header">
                  <h3 class="card-title">IAF/EAC kodovi</h3>
                </div>
                <div class="card-body">
                  {% if company.iaf_eac_codes.all %}
                    <div class="table-responsive">
                      <table class="table table-striped table-hover">
                        <thead class="thead-light">
                          <tr>
                            <th width="15%">IAF/EAC Kod</th>
                            <th>Opis</th>
                            <th width="15%">Status</th>
                            <th width="20%">Napomena</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for code_relation in company.iaf_eac_codes.all %}
                            <tr{% if code_relation.is_primary %} class="table-primary"{% endif %}>
                              <td><strong>{{ code_relation.iaf_eac_code.iaf_code }}</strong></td>
                              <td>{{ code_relation.iaf_eac_code.description }}</td>
                              <td>
                                {% if code_relation.is_primary %}
                                <span class="badge badge-primary">Primarni kod</span>
                                {% else %}
                                <span class="badge badge-secondary">Sekundarni kod</span>
                                {% endif %}
                              </td>
                              <td>{{ code_relation.notes|default:"-" }}</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <p class="text-muted">Kompaniji nisu dodeljeni IAF/EAC kodovi</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      
        <!-- Kontakti Tab -->
        <div class="tab-pane fade" id="contacts" role="tabpanel" aria-labelledby="contacts-tab">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Kontakt osobe</h3>
                </div>
                <div class="card-body">
                  {% if contact_persons %}
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>Ime i prezime</th>
                          <th>Pozicija</th>
                          <th>Email</th>
                          <th>Telefon</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for contact in contact_persons %}
                          <tr{% if contact.is_primary %} class="table-primary"{% endif %}>
                            <td><strong>{{ contact.ime_prezime }}</strong></td>
                            <td>{{ contact.pozicija|default:"-" }}</td>
                            <td>{% if contact.email %}<a href="mailto:{{ contact.email }}">{{ contact.email }}</a>{% else %}-{% endif %}</td>
                            <td>{{ contact.telefon|default:"-" }}</td>
                            <td>{% if contact.is_primary %}<span class="badge badge-primary">Primarni kontakt</span>{% endif %}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  {% else %}
                    <p class="text-muted">Nema kontakt osoba</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      
        <!-- Lokacije Tab -->
        <div class="tab-pane fade" id="locations" role="tabpanel" aria-labelledby="locations-tab">
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Glavna lokacija</h3>
                </div>
                <div class="card-body">
                  <table class="info-table">
                    <tbody>
                      <tr>
                        <td>Naziv:</td>
                        <td><strong>{{ company.name }}</strong> (Glavna lokacija)</td>
                      </tr>
                      <tr>
                        <td>Adresa:</td>
                        <td>{{ company.street }} {{ company.street_number }}, {{ company.city }}, {{ company.postal_code }}</td>
                      </tr>
                      <tr>
                        <td>Telefon:</td>
                        <td>{{ company.phone|default:"Nije unet" }}</td>
                      </tr>
                      <tr>
                        <td>Email:</td>
                        <td>{{ company.email|default:"Nije unet" }}</td>
                      </tr>
                      <tr>
                        <td>Država:</td>
                        <td>{{ company.country|default:"Srbija" }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Ostale lokacije</h3>
                </div>
                <div class="card-body">
                  {% if additional_locations %}
                    <div class="table-responsive">
                      <table class="table table-striped table-hover">
                        <thead class="thead-light">
                          <tr>
                            <th>Naziv</th>
                            <th>Adresa</th>
                            <th>Telefon</th>
                            <th>Email</th>
                            <th>Status</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for location in additional_locations %}
                            <tr>
                              <td><strong>{{ location.name }}</strong></td>
                              <td>{{ location.street }} {{ location.street_number }}, {{ location.city }}</td>
                              <td>{{ location.phone|default:"-" }}</td>
                              <td>{{ location.email|default:"-" }}</td>
                              <td>{% if location.is_active %}<span class="badge badge-success">Aktivna</span>{% else %}<span class="badge badge-secondary">Neaktivna</span>{% endif %}</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <p class="text-muted">Nema dodatnih lokacija</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      
        <!-- Provere i Auditi Tab -->
        <div class="tab-pane fade" id="audits" role="tabpanel" aria-labelledby="audits-tab">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Ciklus sertifikacije</h3>
                </div>
                <div class="card-body">
                  {% if audit_info %}
                    <table class="info-table">
                      <tbody>
                        <tr>
                          <td>Inicijalna provera:</td>
                          <td>{% if audit_info.initial_audit_date %}{{ audit_info.initial_audit_date|date:"d.m.Y" }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                        </tr>
                        <tr>
                          <td>Datum sertifikata:</td>
                          <td>{% if audit_info.certificate_issue_date %}{{ audit_info.certificate_issue_date|date:"d.m.Y" }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                        </tr>
                        <tr>
                          <td>Važenje sertifikata:</td>
                          <td>{% if audit_info.certificate_expiry_date %}{{ audit_info.certificate_expiry_date|date:"d.m.Y" }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                        </tr>
                      </tbody>
                    </table>
                  {% else %}
                    <p class="text-muted">Nema informacija o sertifikaciji</p>
                  {% endif %}
                </div>
              </div>
              
              <div class="card mt-4">
                <div class="card-header">
                  <h3 class="card-title">Naredne provere</h3>
                </div>
                <div class="card-body">
                  {% if audit_info %}
                    <table class="table table-bordered">
                      <thead class="thead-light">
                        <tr>
                          <th>Tip provere</th>
                          <th>Planirano</th>
                          <th>Održano</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td><strong>Prvi nadzor</strong></td>
                          <td>{% if audit_info.first_surv_due %}{{ audit_info.first_surv_due|date:"d.m.Y" }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                          <td>{% if audit_info.first_surv_cond %}{{ audit_info.first_surv_cond|date:"d.m.Y" }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                          <td>
                            {% if audit_info.first_surv_cond %}
                              <span class="badge badge-success">Završeno</span>
                            {% elif audit_info.first_surv_due and audit_info.first_surv_due < today %}
                              <span class="badge badge-danger">Isteklo</span>
                            {% elif audit_info.first_surv_due %}
                              <span class="badge badge-info">Zakazano</span>
                            {% else %}
                              <span class="badge badge-secondary">Nije zakazano</span>
                            {% endif %}
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Drugi nadzor</strong></td>
                          <td>{% if audit_info.second_surv_due %}{{ audit_info.second_surv_due|date:"d.m.Y" }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                          <td>{% if audit_info.second_surv_cond %}{{ audit_info.second_surv_cond|date:"d.m.Y" }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                          <td>
                            {% if audit_info.second_surv_cond %}
                              <span class="badge badge-success">Završeno</span>
                            {% elif audit_info.second_surv_due and audit_info.second_surv_due < today %}
                              <span class="badge badge-danger">Isteklo</span>
                            {% elif audit_info.second_surv_due %}
                              <span class="badge badge-info">Zakazano</span>
                            {% else %}
                              <span class="badge badge-secondary">Nije zakazano</span>
                            {% endif %}
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Resertifikacija</strong></td>
                          <td>{% if audit_info.trinial_audit_due %}{{ audit_info.trinial_audit_due|date:"d.m.Y" }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                          <td>{% if audit_info.trinial_audit_cond %}{{ audit_info.trinial_audit_cond|date:"d.m.Y" }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                          <td>
                            {% if audit_info.trinial_audit_cond %}
                              <span class="badge badge-success">Završeno</span>
                            {% elif audit_info.trinial_audit_due and audit_info.trinial_audit_due < today %}
                              <span class="badge badge-danger">Isteklo</span>
                            {% elif audit_info.trinial_audit_due %}
                              <span class="badge badge-info">Zakazano</span>
                            {% else %}
                              <span class="badge badge-secondary">Nije zakazano</span>
                            {% endif %}
                          </td>
                        </tr>
                      </tbody>
                    </table>
                    <div class="mt-3">
                      <span class="badge badge-{{ audit_info.get_status_color }} float-right">Ukupni status: {{ audit_info.get_status_display }}</span>
                    </div>
                  {% else %}
                    <p class="text-muted">Nema informacija o narednim proverama</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      
        <!-- Sastanci Tab -->
        <div class="tab-pane fade" id="meetings" role="tabpanel" aria-labelledby="meetings-tab">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Sastanci i Termini</h3>
                  <div class="card-tools">
                    <a href="{% url 'company:calendar' %}" class="btn btn-sm btn-primary">
                      <i class="fas fa-calendar"></i> Svi sastanci
                    </a>
                  </div>
                </div>
                <div class="card-body">
                  {% if appointments %}
                    <div class="table-responsive">
                      <table class="table table-striped">
                        <thead>
                          <tr>
                            <th>Naslov</th>
                            <th>Tip</th>
                            <th>Datum</th>
                            <th>Status</th>
                            <th>Akcije</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for appointment in appointments %}
                            <tr>
                              <td>{{ appointment.title }}</td>
                              <td>{{ appointment.get_appointment_type_display }}</td>
                              <td>{{ appointment.start_datetime|date:"d.m.Y H:i" }}</td>
                              <td><span class="badge badge-{{ appointment.get_status_color }}">{{ appointment.get_status_display }}</span></td>
                              <td>
                                <a href="#" class="btn btn-sm btn-info" title="Detalji">
                                  <i class="fas fa-eye"></i>
                                </a>
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <p class="text-muted">Nema zakazanih sastanaka</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
        
      </div> <!-- kraj tab-content -->
    </div> <!-- kraj container-fluid -->
  </div> <!-- kraj content -->
</div> <!-- kraj content-wrapper -->
{% endblock %}
