{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="content-wrapper">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0">{{ title }}</h1>
        </div>
        <div class="col-sm-6">
          <div class="float-sm-right">
            <a href="{% url 'company:list' %}" class="btn btn-secondary">
              <i class="fas fa-arrow-left"></i> Nazad na listu
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="content">
    <div class="container-fluid">          
          <!-- Modal za prikaz obaveznih polja -->
          <div class="modal fade" id="requiredFieldsModal" tabindex="-1" role="dialog" aria-labelledby="requiredFieldsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="requiredFieldsModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning"></i> Obavezna polja
                  </h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <p>Sledeća polja su obavezna za unos:</p>
                  <div id="requiredFieldsList" class="list-group mb-3">
                    <!-- JavaScript će dinamički popuniti ovu listu -->
                  </div>
                  
                  <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Kliknite na neko od polja iz liste da biste prešli na odgovarajući tab i uneli podatak.
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Zatvori</button>
                </div>
              </div>
            </div>
          </div>
    </div>
  </div>

  <div class="content">
    <div class="container-fluid">
      <div class="card">
        <div class="card-body">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- Hidden polja za IAF/EAC kodove i standarde -->
            <input type="hidden" id="iaf_eac_codes_data" name="iaf_eac_codes_data" value="[]">
            <input type="hidden" id="standards_data" name="standards_data" value="[]">
            
            <!-- Tabs navigation -->
            <ul class="nav nav-tabs" id="companyFormTabs" role="tablist">
              <li class="nav-item">
                <a class="nav-link active" id="basic-tab" data-toggle="tab" href="#basic" role="tab" aria-controls="basic" aria-selected="true">
                  <i class="fas fa-info-circle"></i> Osnovne informacije
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="certificate-tab" data-toggle="tab" href="#certificate" role="tab" aria-controls="certificate" aria-selected="false">
                  <i class="fas fa-certificate"></i> Sertifikat
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="standards-tab" data-toggle="tab" href="#standards" role="tab" aria-controls="standards" aria-selected="false">
                  <i class="fas fa-award"></i> Standardi
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="address-tab" data-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="false">
                  <i class="fas fa-map-marker-alt"></i> Adresa i kontakt
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="iaf-tab" data-toggle="tab" href="#iaf" role="tab" aria-controls="iaf" aria-selected="false">
                  <i class="fas fa-tags"></i> IAF/EAC kodovi
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="notes-tab" data-toggle="tab" href="#notes" role="tab" aria-controls="notes" aria-selected="false">
                  <i class="fas fa-sticky-note"></i> Napomene
                </a>
              </li>
            </ul>
            
            <!-- Tab content -->
            <div class="tab-content p-3 border border-top-0 rounded-bottom" id="companyFormTabsContent">
              
              <!-- Tab: Osnovne informacije -->
              <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.name.id_for_label }}">Naziv kompanije *</label>
                      {{ form.name.errors }}
                      <input type="text" name="{{ form.name.name }}" id="{{ form.name.id_for_label }}" 
                             class="form-control {% if form.name.errors %}is-invalid{% endif %}" 
                             value="{{ form.name.value|default:'' }}" required>   
                    </div>
                  </div>
                  
                  <div class="col-md-3">
                    <div class="form-group">
                      <label for="{{ form.pib.id_for_label }}">PIB *</label>
                      {{ form.pib.errors }}
                      <input type="text" name="{{ form.pib.name }}" id="{{ form.pib.id_for_label }}" 
                             class="form-control {% if form.pib.errors %}is-invalid{% endif %}" 
                             value="{{ form.pib.value|default:'' }}" required>
                    </div>
                  </div>
                  
                  <div class="col-md-3">
                    <div class="form-group">
                      <label for="{{ form.mb.id_for_label }}">Matični broj *</label>
                      {{ form.mb.errors }}
                      <input type="text" name="{{ form.mb.name }}" id="{{ form.mb.id_for_label }}" 
                             class="form-control {% if form.mb.errors %}is-invalid{% endif %}" 
                             value="{{ form.mb.value|default:'' }}" required>
                    </div>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="{{ form.industry.id_for_label }}">Industrija *</label>
                      {{ form.industry.errors }}
                      <select name="{{ form.industry.name }}" id="{{ form.industry.id_for_label }}" 
                              class="form-control {% if form.industry.errors %}is-invalid{% endif %}" required>
                        <option value="">Izaberite industriju</option>
                        {% for value, text in form.fields.industry.choices %}
                          <option value="{{ value }}" {% if form.industry.value == value %}selected{% endif %}>
                            {{ text }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="{{ form.number_of_employees.id_for_label }}">Broj zaposlenih</label>
                      {{ form.number_of_employees.errors }}
                      <input type="number" name="{{ form.number_of_employees.name }}" id="{{ form.number_of_employees.id_for_label }}" 
                             class="form-control {% if form.number_of_employees.errors %}is-invalid{% endif %}" 
                             value="{{ form.number_of_employees.value|default:'' }}">
                    </div>
                  </div>
                  
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="{{ form.certificate_status.id_for_label }}">Status sertifikata *</label>
                      {{ form.certificate_status.errors }}
                      <select name="{{ form.certificate_status.name }}" id="{{ form.certificate_status.id_for_label }}" 
                              class="form-control {% if form.certificate_status.errors %}is-invalid{% endif %}" required>
                        <option value="">Izaberite status</option>
                        {% for value, text in form.fields.certificate_status.choices %}
                          <option value="{{ value }}" {% if form.certificate_status.value == value %}selected{% endif %}>
                            {{ text }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Tab: Sertifikat -->
              <div class="tab-pane fade" id="certificate" role="tabpanel" aria-labelledby="certificate-tab">
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="{{ form.certificate_number.id_for_label }}">Broj sertifikata</label>
                      {{ form.certificate_number.errors }}
                      <input type="text" name="{{ form.certificate_number.name }}" id="{{ form.certificate_number.id_for_label }}" 
                             class="form-control {% if form.certificate_number.errors %}is-invalid{% endif %}" 
                             value="{{ form.certificate_number.value|default:'' }}">
                    </div>
                  </div>
                  
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="{{ form.initial_audit_conducted_date.id_for_label }}">Datum inicijalnog audita</label>
                      {{ form.initial_audit_conducted_date.errors }}
                      <input type="date" name="{{ form.initial_audit_conducted_date.name }}" id="{{ form.initial_audit_conducted_date.id_for_label }}" 
                             class="form-control {% if form.initial_audit_conducted_date.errors %}is-invalid{% endif %}" 
                             value="{{ form.initial_audit_conducted_date.value|date:'Y-m-d'|default:'' }}">
                    </div>
                  </div>

                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="{{ form.suspension_until_date.id_for_label }}">Suspenzija do datuma</label>
                      {{ form.suspension_until_date.errors }}
                      <input type="date" name="{{ form.suspension_until_date.name }}" id="{{ form.suspension_until_date.id_for_label }}" 
                             class="form-control {% if form.suspension_until_date.errors %}is-invalid{% endif %}" 
                             value="{{ form.suspension_until_date.value|date:'Y-m-d'|default:'' }}">
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-3">
                    <div class="form-group">
                      <label for="{{ form.audit_days.id_for_label }}">Broj dana audita</label>
                      {{ form.audit_days.errors }}
                      <input type="number" step="0.1" name="{{ form.audit_days.name }}" id="{{ form.audit_days.id_for_label }}" 
                             class="form-control {% if form.audit_days.errors %}is-invalid{% endif %}" 
                             value="{{ form.audit_days.value|default:'' }}">
                    </div>
                  </div>
                  
                  <div class="col-md-3">
                    <div class="form-group">
                      <label for="{{ form.visits_per_year.id_for_label }}">Poseta godišnje</label>
                      {{ form.visits_per_year.errors }}
                      <input type="number" name="{{ form.visits_per_year.name }}" id="{{ form.visits_per_year.id_for_label }}" 
                             class="form-control {% if form.visits_per_year.errors %}is-invalid{% endif %}" 
                             value="{{ form.visits_per_year.value|default:'' }}">
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="form-group">
                      <label for="{{ form.audit_days_each.id_for_label }}">Dana po auditu</label>
                      {{ form.audit_days_each.errors }}
                      <input type="number" step="0.1" name="{{ form.audit_days_each.name }}" id="{{ form.audit_days_each.id_for_label }}" 
                             class="form-control {% if form.audit_days_each.errors %}is-invalid{% endif %}" 
                             value="{{ form.audit_days_each.value|default:'' }}">
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="form-group">
                      <label for="{{ form.oblast_registracije.id_for_label }}">Oblast registracije</label>
                      {{ form.oblast_registracije.errors }}
                      <textarea name="{{ form.oblast_registracije.name }}" id="{{ form.oblast_registracije.id_for_label }}" 
                           class="form-control {% if form.oblast_registracije.errors %}is-invalid{% endif %}" 
                           rows="3">{{ form.oblast_registracije.value|default:'' }}</textarea>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Tab: Standardi -->
              <div class="tab-pane fade" id="standards" role="tabpanel" aria-labelledby="standards-tab">
                <h5 class="mb-3">Standardi</h5>
                <div class="card">
                  <div class="card-body">
                    <div class="table-responsive mb-4">
                      <table class="table table-sm table-striped table-hover">
                        <thead class="thead-light">
                          <tr>
                            <th width="30%">Standard</th>
                            <th width="15%">Datum izdavanja</th>
                            <th width="15%">Datum isteka</th>
                            <th width="25%">Napomena</th>
                            <th width="15%">Akcije</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% if object and object.company_standards.all %}
                            {% for standard in object.company_standards.all %}
                              <tr>
                                <td><strong>{{ standard.standard_definition.standard }}</strong></td>
                                <td>{% if standard.issue_date %}{{ standard.issue_date|date:"d.m.Y" }}{% else %}-{% endif %}</td>
                                <td>{% if standard.expiry_date %}{{ standard.expiry_date|date:"d.m.Y" }}{% else %}-{% endif %}</td>
                                <td>{{ standard.notes|default:"-" }}</td>
                                <td>
                                  <div class="btn-group btn-group-sm">
                                    <a href="{% url 'company:standard_update' company_id=object.id pk=standard.id %}" class="btn btn-outline-primary">
                                      <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="btn btn-outline-danger btn-delete-standard" 
                                      data-standard-id="{{ standard.id }}" 
                                      data-standard-name="{{ standard.standard_definition.standard|escapejs }}" 
                                      data-company-id="{{ object.id }}">
                                      <i class="fas fa-trash"></i>
                                    </button>
                                  </div>
                                </td>
                              </tr>
                            {% endfor %}
                          {% else %}
                            <tr>
                              <td colspan="5" class="text-center">
                                <div class="alert alert-info mb-0">
                                  <i class="fas fa-info-circle"></i> Kompaniji nisu dodeljeni standardi. Dodajte standarde ispod.
                                </div>
                              </td>
                            </tr>
                          {% endif %}
                        </tbody>
                      </table>
                    </div>

                    <!-- Forma za dodavanje novog standarda -->
                    <div class="alert alert-info mb-3 small">
                      <strong>Debug info:</strong> Company ID: {{ object.id|default:'None' }} 
                    </div>
                    <form method="post" action="{% url 'company:standard_create' company_id=object.id|default:0 %}" class="mt-4" id="standardAddForm">
                      {% csrf_token %}
                      <h6 class="font-weight-bold mb-3">Dodaj novi standard</h6>
                      
                      <div class="row">
                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="standard_definition">Izaberite standard</label>
                            <select id="standard_definition" name="standard_definition" class="form-control" required>
                              <option value="">-- Izaberite standard --</option>
                              {% for standard in all_standard_definitions %}
                                <option value="{{ standard.id }}">
                                  {{ standard.standard }}
                                </option>
                              {% endfor %}
                            </select>
                          </div>
                        </div>
                        <div class="col-md-2">
                          <div class="form-group">
                            <label for="issue_date">Datum izdavanja</label>
                            <input type="date" id="issue_date" name="issue_date" class="form-control" placeholder="Datum izdavanja">
                          </div>
                        </div>
                        <div class="col-md-2">
                          <div class="form-group">
                            <label for="expiry_date">Datum isteka</label>
                            <input type="date" id="expiry_date" name="expiry_date" class="form-control" placeholder="Datum isteka">
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="notes">Napomena</label>
                            <input type="text" id="notes" name="notes" class="form-control" placeholder="Unesite napomenu (opciono)">
                          </div>
                        </div>
                      </div>

                      <div class="form-group">
                        <button type="button" id="directStandardAdd" class="btn btn-success" data-company-id="{{ object.id|default:0 }}">
                          <i class="fas fa-plus"></i> Dodaj standard
                        </button>
                      </div>
                    </form>
                    
                    <!-- Skrivena polja više nisu potrebna jer koristimo backend pristup -->
                  </div>
                </div>
              </div>
              
              <!-- Tab: Adresa i kontakt -->
              <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                <h5 class="mb-3">Adresa</h5>
                
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.street.id_for_label }}">Ulica *</label>
                      {{ form.street.errors }}
                      <input type="text" name="{{ form.street.name }}" id="{{ form.street.id_for_label }}" 
                             class="form-control {% if form.street.errors %}is-invalid{% endif %}" 
                             value="{{ form.street.value|default:'' }}" required>
                    </div>
                  </div>
                  
                  <div class="col-md-2">
                    <div class="form-group">
                      <label for="{{ form.street_number.id_for_label }}">Broj *</label>
                      {{ form.street_number.errors }}
                      <input type="text" name="{{ form.street_number.name }}" id="{{ form.street_number.id_for_label }}" 
                             class="form-control {% if form.street_number.errors %}is-invalid{% endif %}" 
                             value="{{ form.street_number.value|default:'' }}" required>
                    </div>
                  </div>
                  
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="{{ form.city.id_for_label }}">Grad *</label>
                      {{ form.city.errors }}
                      <select name="{{ form.city.name }}" id="{{ form.city.id_for_label }}" 
                              class="form-control {% if form.city.errors %}is-invalid{% endif %}" required>
                        <option value="">Izaberite grad</option>
                        {% for value, text in form.fields.city.choices %}
                          <option value="{{ value }}" {% if form.city.value == value %}selected{% endif %}>
                            {{ text }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="{{ form.postal_code.id_for_label }}">Poštanski broj</label>
                      {{ form.postal_code.errors }}
                      <input type="text" name="{{ form.postal_code.name }}" id="{{ form.postal_code.id_for_label }}" 
                             class="form-control {% if form.postal_code.errors %}is-invalid{% endif %}" 
                             value="{{ form.postal_code.value|default:'' }}">
                    </div>
                  </div>
                </div>
                
                <h5 class="mt-4 mb-3">Kontakt informacije</h5>
                
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="{{ form.phone.id_for_label }}">Telefon</label>
                      {{ form.phone.errors }}
                      <input type="tel" name="{{ form.phone.name }}" id="{{ form.phone.id_for_label }}" 
                             class="form-control {% if form.phone.errors %}is-invalid{% endif %}" 
                             value="{{ form.phone.value|default:'' }}">
                    </div>
                  </div>
                  
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="{{ form.email.id_for_label }}">Email</label>
                      {{ form.email.errors }}
                      <input type="email" name="{{ form.email.name }}" id="{{ form.email.id_for_label }}" 
                             class="form-control {% if form.email.errors %}is-invalid{% endif %}" 
                             value="{{ form.email.value|default:'' }}">
                    </div>
                  </div>
                  
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="{{ form.website.id_for_label }}">Website</label>
                      {{ form.website.errors }}
                      <input type="url" name="{{ form.website.name }}" id="{{ form.website.id_for_label }}" 
                             class="form-control {% if form.website.errors %}is-invalid{% endif %}" 
                             value="{{ form.website.value|default:'' }}" placeholder="https://">
                    </div>
                  </div>
                </div>
              </div>
            
            <!-- Tab: IAF/EAC Kodovi -->
              <div class="tab-pane fade" id="iaf" role="tabpanel" aria-labelledby="iaf-tab">
                <h5 class="mb-3">IAF/EAC Kodovi</h5>
                <div class="card">
                  <div class="card-body">
                    <div class="table-responsive mb-4">
                      <table class="table table-sm table-striped table-hover">
                        <thead class="thead-light">
                          <tr>
                            <th width="15%">IAF/EAC kod</th>
                            <th width="40%">Opis</th>
                            <th width="15%">Status</th>
                            <th width="15%">Napomena</th>
                            <th width="15%">Akcije</th>
                          </tr>
                        </thead>
                        <tbody id="iaf-eac-codes-list">
                          <!-- JavaScript će dinamički popuniti tabelu sa IAF/EAC kodovima -->
                        </tbody>
                      </table>
                    </div>
                    <div class="alert alert-info" id="no-iaf-codes-message" style="display: none;">
                      <i class="fas fa-info-circle"></i> Kompaniji nisu dodeljeni IAF/EAC kodovi. Dodajte kodove ispod.
                    </div>

                    <div class="row">
                      <div class="col-md-5">
                        <div class="form-group">
                          <label for="iaf_eac_code_select">Izaberite IAF/EAC kod</label>
                          <select id="iaf_eac_code_select" class="form-control">
                            <option value="">-- Izaberite kod --</option>
                            {% for code in all_iaf_eac_codes %}
                              <option value="{{ code.id }}" data-description="{{ code.description }}">
                                {{ code.iaf_code }} - {{ code.description|truncatechars:50 }}
                              </option>
                            {% endfor %}
                          </select>
                        </div>
                      </div>
                      <div class="col-md-5">
                        <div class="form-group">
                          <label for="iaf_eac_code_notes">Napomena</label>
                          <input type="text" id="iaf_eac_code_notes" class="form-control" placeholder="Unesite napomenu (opciono)">
                        </div>
                      </div>
                      <div class="col-md-2">
                        <div class="form-group">
                          <label for="iaf_eac_is_primary" class="d-block">Primarni</label>
                          <div class="form-check">
                            <input type="checkbox" id="iaf_eac_is_primary" class="form-check-input">
                            <label class="form-check-label" for="iaf_eac_is_primary">Postavi kao primarni</label>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="form-group">
                      <button type="button" class="btn btn-success" id="addIafEacButton" data-company-id="{{ object.id|default:0 }}">
                        <i class="fas fa-plus"></i> Dodaj IAF/EAC kod
                      </button>
                    </div>
                    
                    <!-- Skriveno polje za IAF/EAC kodove -->
                    <input type="hidden" name="iaf_eac_codes_data" id="iaf_eac_codes_data" value="">
                  </div>
                </div>
              </div>
              
              <!-- Tab: Napomene -->
              <div class="tab-pane fade" id="notes" role="tabpanel" aria-labelledby="notes-tab">
                <div class="form-group">
                  <label for="{{ form.notes.id_for_label }}">Napomene</label>
                  {{ form.notes.errors }}
                  <textarea name="{{ form.notes.name }}" id="{{ form.notes.id_for_label }}" 
                            class="form-control {% if form.notes.errors %}is-invalid{% endif %}" 
                            rows="8">{{ form.notes.value|default:'' }}</textarea>
                </div>
              </div>
            </div>
            
            <div class="form-group mt-4">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> {{ submit_text }}
              </button>
              <a href="{% url 'company:list' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Otkaži
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
{% load static %}
<!-- Uključi eksternu JavaScript datoteku -->  
<script src="{% static 'js/company/company-form.js' %}"></script>
  <!-- Pripremi podatke za JS -->
{% load static %}
<script>

  // Dodavanje skrivenog polja za čuvanje podataka o obrisanim standardima
  if (!$('#deleted_standards').length) {
    $('form').append('<input type="hidden" id="deleted_standards" name="deleted_standards" value="[]">');
  }

  // Funkcija za pripremu podataka o standardima za slanje forme
  function prepareStandardsData() {
    $('#standards_data').val(JSON.stringify(standardsData));
  }

  // Funkcija za formatiranje datuma za prikaz
  function formatDateDisplay(dateStr) {
    if (!dateStr) return '-';
    var date = new Date(dateStr);
    return ('0' + date.getDate()).slice(-2) + '.' + ('0' + (date.getMonth() + 1)).slice(-2) + '.' + date.getFullYear() + '.';
  }

    // Funkcija za osvežavanje prikaza tabele standarda
    function updateStandardsTable() {
      var tableBody = $('#standards-list');
      var noStandardsMessage = $('#no-standards-message');
      
      if (standardsData.length === 0) {
        tableBody.html('');
        noStandardsMessage.show();
        return;
      }
      
      noStandardsMessage.hide();
      
      var html = '';
      for (var i = 0; i < standardsData.length; i++) {
        var item = standardsData[i];
        var rowId = item.standard_id ? 'standard-' + item.standard_id : 'new-standard-' + i;
        
        html += '<tr id="' + rowId + '">' +
                '<td><strong>' + item.name + '</strong></td>' +
                '<td>' + formatDisplayDate(item.issue_date) + '</td>' +
                '<td>' + formatDisplayDate(item.expiry_date) + '</td>' +
                '<td>' + (item.notes || '-') + '</td>' +
                '<td>' +
                  '<div class="btn-group btn-group-sm">' +
                    '<button type="button" class="btn btn-outline-danger btn-remove-standard" data-index="' + i + '">' +
                      '<i class="fas fa-trash"></i>' +
                    '</button>' +
                  '</div>' +
                '</td>' +
              '</tr>';
      }
      
      tableBody.html(html);
      
      // Dodajemo event listener za brisanje standarda
      $('.btn-remove-standard').off('click').on('click', function() {
        var index = $(this).data('index');
        standardsData.splice(index, 1);
        updateStandardsTable();
      });
    }

    // Funkcija za dodavanje novog standarda
    function addStandard() {
      var standardSelect = $('#standard_definition_select');
      var standardId = standardSelect.val();
      
      if (!standardId) {
        alert('Molimo izaberite standard');
        return;
      }

      // Provera da li standard već postoji
      for (var i = 0; i < standardsData.length; i++) {
        if (standardsData[i].id == standardId) {
          alert('Ovaj standard je već dodat!');
          return;
        }
      }
      
      var standardText = standardSelect.find('option:selected').text().trim();
      var issueDate = $('#standard_issue_date').val() || '';
      var expiryDate = $('#standard_expiry_date').val() || '';
      var notes = $('#standard_notes').val() || '';
      
      // Dodajemo novi standard u listu
      standardsData.push({
        id: parseInt(standardId),
        name: standardText,
        issue_date: issueDate,
        expiry_date: expiryDate,
        notes: notes
      });
      
      // Osvežavamo prikaz tabele
      updateStandardsTable();
      
      // Resetujemo polja forme
      standardSelect.val('');
      $('#standard_issue_date').val('');
      $('#standard_expiry_date').val('');
      $('#standard_notes').val('');
    }

    // Event handler za dodavanje standarda na klik dugmeta
    $('#add-standard').off('click').on('click', function(e) {
      e.preventDefault();
      addStandard();
    });

    // Postavljamo event handler za submit forme da pripremi podatke o standardima
    $('form').on('submit', function() {
      prepareStandardsData();
    });

    // Inicijalno osvežavanje tabele standarda
    updateStandardsTable();
    // Inicijalno ažuriranje prikaza IAF/EAC kodova
    updateIAFEACTable();
</script>

<!-- Modal za potvrdu brisanja standarda -->
<div class="modal fade" id="deleteStandardModal" tabindex="-1" role="dialog" aria-labelledby="deleteStandardModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger">
        <h5 class="modal-title" id="deleteStandardModalLabel">Potvrda brisanja standarda</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Da li ste sigurni da želite da obrišete standard <strong id="standardToDeleteName"></strong>?</p>
        <input type="hidden" id="standardToDeleteId" name="standardToDeleteId" value="">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Otkaži</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteStandard">Obriši</button>
      </div>
    </div>
  </div>
</div>

<!-- Koristićemo lokalne biblioteke koje sada poslužuje Nginx sa ispravnim MIME tipovima -->

<!-- Inicijalizacija modalnih dijaloga -->
<script>
  $(document).ready(function() {
    // Osiguraj da modalni dijalozi budu pravilno inicijalzovani
    $('#deleteStandardModal').modal({
      show: false, // Ne prikazuj automatski
      backdrop: 'static' // Spreči zatvaranje klikom van modala
    });
    
    console.log('Modal dialog initialized:', $('#deleteStandardModal').length > 0);
    
    // Handler za dugme za brisanje standarda
    $('#standards-list').off('click', '.btn-remove-standard').on('click', '.btn-remove-standard', function() {
      var standardId = $(this).data('id');
      var standardName = $(this).closest('tr').find('td:first-child strong').text();
      console.log('Clicked remove button, standardId:', standardId);
      console.log('Standard name:', standardName);
      
      // Postavi vrednosti u modalni dijalog
      $('#standardToDeleteName').text(standardName);
      $('#standardToDeleteId').val(standardId);
      
      // Prikaži modalni dijalog
      $('#deleteStandardModal').modal('show');
    });
    
    // Handler za potvrdu brisanja standarda
    $('#confirmDeleteStandard').off('click').on('click', function() {
      var standardId = $('#standardToDeleteId').val();
      console.log('Confirming deletion of standard ID:', standardId);
      
      // Dobavi CSRF token iz dokumenta
      var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
      
      // Pošalji AJAX zahtev za brisanje standarda
      $.ajax({
        url: '{% url "company:delete_standard" %}',
        type: 'POST',
        data: {
          'standard_id': standardId,
          'csrfmiddlewaretoken': csrfToken
        },
        success: function(response) {
          console.log('Standard successfully deleted:', response);
          
          // Sakrij modalni dijalog
          $('#deleteStandardModal').modal('hide');
          
          // Ukloni red iz tabele
          $('#standard-' + standardId).remove();
          
          // Prikaži poruku o uspešnom brisanju
          toastr.success('Standard je uspešno obrisan.');
        },
        error: function(xhr, status, error) {
          console.error('Error deleting standard:', error);
          
          // Sakrij modalni dijalog
          $('#deleteStandardModal').modal('hide');
          
          // Prikaži poruku o grešci
          toastr.error('Došlo je do greške pri brisanju standarda.');
        }
      });
    });
  });
</script>

<!-- Modal za potvrdu brisanja standarda -->
<div class="modal fade" id="deleteStandardModal" tabindex="-1" role="dialog" aria-labelledby="deleteStandardModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteStandardModalLabel">Potvrda brisanja standarda</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Da li ste sigurni da želite da obrišete standard <strong id="standardNameToDelete"></strong>?</p>
        <p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Ova akcija je nepovratna!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Odustani</button>
        <form id="deleteStandardForm" method="post" action="">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Obriši</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal za potvrdu brisanja standarda -->
<div class="modal fade" id="deleteStandardModal" tabindex="-1" role="dialog" aria-labelledby="deleteStandardModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteStandardModalLabel">Potvrda brisanja standarda</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Da li ste sigurni da želite da obrišete standard <strong id="standardNameToDelete"></strong>?</p>
        <p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Ova akcija je nepovratna!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Odustani</button>
        <form id="deleteStandardForm" method="post" action="">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Obriši</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modali za uspeh i greške pri radu sa standardima -->
{% include 'company/standard-success-modal.html' %}
{% include 'company/standard-validation-modal.html' %}

{% endblock %}

{% block extra_scripts %}
<!-- JS za upravljanje standardima i IAF/EAC kodovima (modularno, u skladu sa reorganizacijom frontend koda) -->
<script src="/static/js/company/direct-modal.js"></script>

<!-- Komponente za standarde -->
<script src="/static/js/company/standards-delete-modal.js"></script>
<script src="/static/js/company/standards-form.js"></script>
<script src="/static/js/company/standard-direct-add.js"></script>

<!-- Komponenta za IAF/EAC kodove - objedinjena -->
<script src="/static/js/company/iaf-eac-handler.js"></script>
<script src="/static/js/company/iaf-eac-table-clean.js"></script>
{% endblock %}
