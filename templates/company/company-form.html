{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap4-theme@1.0.0/dist/select2-bootstrap4.min.css" rel="stylesheet" />
<link rel="stylesheet" href="{% static 'css/company/company-detail.css' %}">
{% endblock %}

{% block content %}
<div class="content-wrapper">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0">{{ title }}</h1>
        </div>
        <div class="col-sm-6">
          <div class="float-sm-right">
            <a href="{% url 'company:list' %}" class="btn btn-secondary">
              <i class="fas fa-arrow-left"></i> Nazad na listu
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="content">
    <div class="container-fluid">          
          <!-- Modal za prikaz obaveznih polja -->
          <div class="modal fade" id="requiredFieldsModal" tabindex="-1" role="dialog" aria-labelledby="requiredFieldsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="requiredFieldsModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning"></i> Obavezna polja
                  </h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <p>Sledeća polja su obavezna za unos:</p>
                  <div id="requiredFieldsList" class="list-group mb-3">
                    <!-- JavaScript će dinamički popuniti ovu listu -->
                  </div>
                  
                  <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Kliknite na neko od polja iz liste da biste prešli na odgovarajući tab i uneli podatak.
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Zatvori</button>
                </div>
              </div>
            </div>
          </div>
    </div>
  </div>

  <div class="content">
    <div class="container-fluid">
      <div class="card">
        <div class="card-body">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- Hidden polja za IAF/EAC kodove i standarde -->
            <input type="hidden" id="iaf_eac_codes_data" name="iaf_eac_codes_data" value="[]">
            <input type="hidden" id="standards_data" name="standards_data" value="[]">
            
            <!-- Tabs navigation -->
            <ul class="nav nav-tabs company-tabs" id="companyFormTabs" role="tablist">
              <li class="nav-item">
                <a class="nav-link active" id="basic-tab" data-toggle="tab" href="#basic" role="tab" aria-controls="basic" aria-selected="true">
                  <i class="fas fa-info-circle"></i> Osnovni Podaci
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="standards-tab" data-toggle="tab" href="#standards" role="tab" aria-controls="standards" aria-selected="false">
                  <i class="fas fa-certificate"></i> Standardi i Sertifikati
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="iaf-tab" data-toggle="tab" href="#iaf" role="tab" aria-controls="iaf" aria-selected="false">
                  <i class="fas fa-tags"></i> IAF/EAC Kodovi
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="contacts-tab" data-toggle="tab" href="#contacts" role="tab" aria-controls="contacts" aria-selected="false">
                  <i class="fas fa-address-book"></i> Kontakti
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="locations-tab" data-toggle="tab" href="#locations" role="tab" aria-controls="locations" aria-selected="false">
                  <i class="fas fa-map-marker-alt"></i> Lokacije
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="audits-tab" data-toggle="tab" href="#audits" role="tab" aria-controls="audits" aria-selected="false">
                  <i class="fas fa-clipboard-check"></i> Provere i Auditi
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="meetings-tab" data-toggle="tab" href="#meetings" role="tab" aria-controls="meetings" aria-selected="false">
                  <i class="fas fa-calendar-alt"></i> Sastanci
                </a>
              </li>
            </ul>
            
            <!-- Tab content -->
            <div class="tab-content p-3 border border-top-0 rounded-bottom" id="companyFormTabsContent">
              
              <!-- Tab: Osnovne informacije -->
              <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.name.id_for_label }}">Naziv kompanije *</label>
                      {{ form.name.errors }}
                      <input type="text" name="{{ form.name.name }}" id="{{ form.name.id_for_label }}" 
                             class="form-control {% if form.name.errors %}is-invalid{% endif %}" 
                             value="{{ form.name.value|default:'' }}" required>   
                    </div>
                  </div>
                  
                  <div class="col-md-3">
                    <div class="form-group">
                      <label for="{{ form.pib.id_for_label }}">PIB *</label>
                      {{ form.pib.errors }}
                      <input type="text" name="{{ form.pib.name }}" id="{{ form.pib.id_for_label }}" 
                             class="form-control {% if form.pib.errors %}is-invalid{% endif %}" 
                             value="{{ form.pib.value|default:'' }}" required>
                    </div>
                  </div>
                  
                  <div class="col-md-3">
                    <div class="form-group">
                      <label for="{{ form.mb.id_for_label }}">Matični broj *</label>
                      {{ form.mb.errors }}
                      <input type="text" name="{{ form.mb.name }}" id="{{ form.mb.id_for_label }}" 
                             class="form-control {% if form.mb.errors %}is-invalid{% endif %}" 
                             value="{{ form.mb.value|default:'' }}" required>
                    </div>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="{{ form.industry.id_for_label }}">Industrija *</label>
                      {{ form.industry.errors }}
                      <select name="{{ form.industry.name }}" id="{{ form.industry.id_for_label }}" 
                              class="form-control {% if form.industry.errors %}is-invalid{% endif %}" required>
                        <option value="">Izaberite industriju</option>
                        {% for value, text in form.fields.industry.choices %}
                          <option value="{{ value }}" {% if form.industry.value == value %}selected{% endif %}>
                            {{ text }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="{{ form.number_of_employees.id_for_label }}">Broj zaposlenih</label>
                      {{ form.number_of_employees.errors }}
                      <input type="number" name="{{ form.number_of_employees.name }}" id="{{ form.number_of_employees.id_for_label }}" 
                             class="form-control {% if form.number_of_employees.errors %}is-invalid{% endif %}" 
                             value="{{ form.number_of_employees.value|default:'' }}">
                    </div>
                  </div>
                  
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="{{ form.certificate_status.id_for_label }}">Status sertifikata *</label>
                      {{ form.certificate_status.errors }}
                      <select name="{{ form.certificate_status.name }}" id="{{ form.certificate_status.id_for_label }}" 
                              class="form-control {% if form.certificate_status.errors %}is-invalid{% endif %}" required>
                        <option value="">Izaberite status</option>
                        {% for value, text in form.fields.certificate_status.choices %}
                          <option value="{{ value }}" {% if form.certificate_status.value == value %}selected{% endif %}>
                            {{ text }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Tab: Sertifikat je uklonjen; sadržaj je prebačen u tab 'Standardi i Sertifikati' -->
              
              <!-- Tab: Standardi i Sertifikati -->
              <div class="tab-pane fade" id="standards" role="tabpanel" aria-labelledby="standards-tab">
                <h5 class="mb-3">Standardi i Sertifikati</h5>
                <!-- Sekcija: Podaci o sertifikatu (prebačeno iz posebnog taba) -->
                <div class="card card-info mb-3">
                  <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-id-badge"></i> Podaci o sertifikatu</h3>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ form.certificate_number.id_for_label }}">Broj sertifikata</label>
                          {{ form.certificate_number.errors }}
                          <input type="text" name="{{ form.certificate_number.name }}" id="{{ form.certificate_number.id_for_label }}" 
                                 class="form-control {% if form.certificate_number.errors %}is-invalid{% endif %}" 
                                 value="{{ form.certificate_number.value|default:'' }}">
                        </div>
                      </div>
                      
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ form.initial_audit_conducted_date.id_for_label }}">Datum inicijalnog audita</label>
                          {{ form.initial_audit_conducted_date.errors }}
                          <input type="date" name="{{ form.initial_audit_conducted_date.name }}" id="{{ form.initial_audit_conducted_date.id_for_label }}" 
                                 class="form-control {% if form.initial_audit_conducted_date.errors %}is-invalid{% endif %}" 
                                 value="{{ form.initial_audit_conducted_date.value|date:'Y-m-d'|default:'' }}">
                        </div>
                      </div>

                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ form.suspension_until_date.id_for_label }}">Suspenzija do datuma</label>
                          {{ form.suspension_until_date.errors }}
                          <input type="date" name="{{ form.suspension_until_date.name }}" id="{{ form.suspension_until_date.id_for_label }}" 
                                 class="form-control {% if form.suspension_until_date.errors %}is-invalid{% endif %}" 
                                 value="{{ form.suspension_until_date.value|date:'Y-m-d'|default:'' }}">
                        </div>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-3">
                        <div class="form-group">
                          <label for="{{ form.audit_days.id_for_label }}">Broj dana audita</label>
                          {{ form.audit_days.errors }}
                          <input type="number" step="0.1" name="{{ form.audit_days.name }}" id="{{ form.audit_days.id_for_label }}" 
                                 class="form-control {% if form.audit_days.errors %}is-invalid{% endif %}" 
                                 value="{{ form.audit_days.value|default:'' }}">
                        </div>
                      </div>
                      
                      <div class="col-md-3">
                        <div class="form-group">
                          <label for="{{ form.visits_per_year.id_for_label }}">Poseta godišnje</label>
                          {{ form.visits_per_year.errors }}
                          <input type="number" name="{{ form.visits_per_year.name }}" id="{{ form.visits_per_year.id_for_label }}" 
                                 class="form-control {% if form.visits_per_year.errors %}is-invalid{% endif %}" 
                                 value="{{ form.visits_per_year.value|default:'' }}">
                        </div>
                      </div>

                      <div class="col-md-3">
                        <div class="form-group">
                          <label for="{{ form.audit_days_each.id_for_label }}">Dana po auditu</label>
                          {{ form.audit_days_each.errors }}
                          <input type="number" step="0.1" name="{{ form.audit_days_each.name }}" id="{{ form.audit_days_each.id_for_label }}" 
                                 class="form-control {% if form.audit_days_each.errors %}is-invalid{% endif %}" 
                                 value="{{ form.audit_days_each.value|default:'' }}">
                        </div>
                      </div>

                      <div class="col-md-3">
                        <div class="form-group">
                          <label for="{{ form.oblast_registracije.id_for_label }}">Oblast registracije</label>
                          {{ form.oblast_registracije.errors }}
                          <textarea name="{{ form.oblast_registracije.name }}" id="{{ form.oblast_registracije.id_for_label }}" 
                               class="form-control {% if form.oblast_registracije.errors %}is-invalid{% endif %}" 
                               rows="3">{{ form.oblast_registracije.value|default:'' }}</textarea>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="card">
                  <div class="card-body">
                    <div class="table-responsive mb-4">
                      <table class="table table-sm table-striped table-hover">
                        <thead class="thead-light">
                          <tr>
                            <th width="30%">Standard</th>
                            <th width="15%">Datum izdavanja</th>
                            <th width="15%">Datum isteka</th>
                            <th width="25%">Napomena</th>
                            <th width="15%">Akcije</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% if object and object.company_standards.all %}
                            {% for standard in object.company_standards.all %}
                              <tr>
                                <td><strong>{{ standard.standard_definition.standard }}</strong></td>
                                <td>{% if standard.issue_date %}{{ standard.issue_date|date:"d.m.Y" }}{% else %}-{% endif %}</td>
                                <td>{% if standard.expiry_date %}{{ standard.expiry_date|date:"d.m.Y" }}{% else %}-{% endif %}</td>
                                <td>{{ standard.notes|default:"-" }}</td>
                                <td>
                                  <div class="btn-group btn-group-sm">
                                    <a href="{% url 'company:standard_detail' company_id=object.id pk=standard.id %}" class="btn btn-outline-info">
                                      <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{% url 'company:standard_update' company_id=object.id pk=standard.id %}" class="btn btn-outline-primary">
                                      <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="btn btn-outline-danger btn-delete-standard" 
                                      data-standard-id="{{ standard.id }}" 
                                      data-standard-name="{{ standard.standard_definition.standard|escapejs }}" 
                                      data-company-id="{{ object.id }}">
                                      <i class="fas fa-trash"></i>
                                    </button>
                                  </div>
                                </td>
                              </tr>
                            {% endfor %}
                          {% else %}
                            <tr>
                              <td colspan="5" class="text-center">
                                <div class="alert alert-info mb-0">
                                  <i class="fas fa-info-circle"></i> Kompaniji nisu dodeljeni standardi. Dodajte standarde ispod.
                                </div>
                              </td>
                            </tr>
                          {% endif %}
                        </tbody>
                      </table>
                    </div>

                    <!-- Forma za dodavanje novog standarda -->
                    <form method="post" action="{% url 'company:standard_create' company_id=object.id|default:0 %}" class="mt-4" id="standardAddForm">
                      {% csrf_token %}
                      <h6 class="font-weight-bold mb-3">Dodaj novi standard</h6>
                      
                      <div class="row">
                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="standard_definition">Izaberite standard</label>
                            <select id="standard_definition" name="standard_definition" class="form-control" required>
                              <option value="">-- Izaberite standard --</option>
                              {% for standard in all_standard_definitions %}
                                <option value="{{ standard.id }}">
                                  {{ standard.standard }}
                                </option>
                              {% endfor %}
                            </select>
                          </div>
                        </div>
                        <div class="col-md-2">
                          <div class="form-group">
                            <label for="issue_date">Datum izdavanja</label>
                            <input type="date" id="issue_date" name="issue_date" class="form-control issue-date-input" placeholder="Datum izdavanja">
                          </div>
                        </div>
                        <div class="col-md-2">
                          <div class="form-group">
                            <label for="expiry_date">Datum isteka</label>
                            <input type="date" id="expiry_date" name="expiry_date" class="form-control expiry-date-input" placeholder="Datum isteka">
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="notes">Napomena</label>
                            <input type="text" id="notes" name="notes" class="form-control" placeholder="Unesite napomenu (opciono)">
                          </div>
                        </div>
                      </div>
                      
                      <!-- Dodavanje auditora za standard -->
                      <div class="row mb-3">
                        <div class="col-12">
                          <div class="form-group">
                            <label for="auditors">Auditori za standard</label>
                            <select id="auditors" name="auditors[]" class="form-control select2" multiple>
                              {% for auditor in all_auditors %}
                                <option value="{{ auditor.id }}">
                                  {{ auditor.ime_prezime }} {% if auditor.kategorija %}({{ auditor.get_kategorija_display }}){% endif %}
                                </option>
                              {% endfor %}
                            </select>
                            <small class="form-text text-muted">Izaberite jednog ili više auditora koji su odgovorni za sertifikaciju ovog standarda.</small>
                          </div>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              
              <!-- Tab: Lokacije -->
              <div class="tab-pane fade" id="locations" role="tabpanel" aria-labelledby="locations-tab">
                <h5 class="mb-3"><i class="fas fa-map-marker-alt"></i> Lokacije kompanije</h5>
                
                <!-- Glavna lokacija -->
                <div class="card card-primary card-outline mb-4 shadow-sm">
                  <div class="card-header bg-primary text-white">
                    <h3 class="card-title"><i class="fas fa-home"></i> Glavna lokacija</h3>
                  </div>
                  <div class="card-body">
                    <h5 class="mb-3"><i class="fas fa-map"></i> Adresa</h5>
                    
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.street.id_for_label }}"><i class="fas fa-road"></i> Ulica *</label>
                          {{ form.street.errors }}
                          <div class="input-group">
                            <div class="input-group-prepend">
                              <span class="input-group-text bg-light"><i class="fas fa-road text-primary"></i></span>
                            </div>
                            <input type="text" name="{{ form.street.name }}" id="{{ form.street.id_for_label }}" 
                                   class="form-control {% if form.street.errors %}is-invalid{% endif %}" 
                                   value="{{ form.street.value|default:'' }}" required placeholder="npr. Bulevar oslobođenja">
                          </div>
                        </div>
                      </div>
                      
                      <div class="col-md-2">
                        <div class="form-group">
                          <label for="{{ form.street_number.id_for_label }}"><i class="fas fa-hashtag"></i> Broj *</label>
                          {{ form.street_number.errors }}
                          <div class="input-group">
                            <div class="input-group-prepend">
                              <span class="input-group-text bg-light"><i class="fas fa-hashtag text-primary"></i></span>
                            </div>
                            <input type="text" name="{{ form.street_number.name }}" id="{{ form.street_number.id_for_label }}" 
                                   class="form-control {% if form.street_number.errors %}is-invalid{% endif %}" 
                                   value="{{ form.street_number.value|default:'' }}" required placeholder="npr. 76">
                          </div>
                        </div>
                      </div>
                      
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ form.city.id_for_label }}"><i class="fas fa-city"></i> Grad *</label>
                          {{ form.city.errors }}
                          <div class="input-group">
                            <div class="input-group-prepend">
                              <span class="input-group-text bg-light"><i class="fas fa-city text-primary"></i></span>
                            </div>
                            <select name="{{ form.city.name }}" id="{{ form.city.id_for_label }}" 
                                    class="form-control {% if form.city.errors %}is-invalid{% endif %}" required>
                              <option value="">Izaberite grad</option>
                              {% for value, text in form.fields.city.choices %}
                                <option value="{{ value }}" {% if form.city.value == value %}selected{% endif %}>
                                  {{ text }}
                                </option>
                              {% endfor %}
                            </select>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="row">
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ form.postal_code.id_for_label }}"><i class="fas fa-mail-bulk"></i> Poštanski broj</label>
                          {{ form.postal_code.errors }}
                          <div class="input-group">
                            <div class="input-group-prepend">
                              <span class="input-group-text bg-light"><i class="fas fa-mail-bulk text-primary"></i></span>
                            </div>
                            <input type="text" name="{{ form.postal_code.name }}" id="{{ form.postal_code.id_for_label }}" 
                                   class="form-control {% if form.postal_code.errors %}is-invalid{% endif %}" 
                                   value="{{ form.postal_code.value|default:'' }}" placeholder="npr. 11000">
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <h5 class="mt-4 mb-3"><i class="fas fa-address-card"></i> Kontakt informacije</h5>
                    
                    <div class="row">
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ form.phone.id_for_label }}"><i class="fas fa-phone"></i> Telefon</label>
                          {{ form.phone.errors }}
                          <div class="input-group">
                            <div class="input-group-prepend">
                              <span class="input-group-text bg-light"><i class="fas fa-phone text-primary"></i></span>
                            </div>
                            <input type="tel" name="{{ form.phone.name }}" id="{{ form.phone.id_for_label }}" 
                                   class="form-control {% if form.phone.errors %}is-invalid{% endif %}" 
                                   value="{{ form.phone.value|default:'' }}" placeholder="npr. +381 11 123-4567">
                          </div>
                        </div>
                      </div>
                      
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ form.email.id_for_label }}"><i class="fas fa-envelope"></i> Email</label>
                          {{ form.email.errors }}
                          <div class="input-group">
                            <div class="input-group-prepend">
                              <span class="input-group-text bg-light"><i class="fas fa-envelope text-primary"></i></span>
                            </div>
                            <input type="email" name="{{ form.email.name }}" id="{{ form.email.id_for_label }}" 
                                   class="form-control {% if form.email.errors %}is-invalid{% endif %}" 
                                   value="{{ form.email.value|default:'' }}" placeholder="npr. info@kompanija.rs">
                          </div>
                        </div>
                      </div>
                      
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ form.website.id_for_label }}"><i class="fas fa-globe"></i> Website</label>
                          {{ form.website.errors }}
                          <div class="input-group">
                            <div class="input-group-prepend">
                              <span class="input-group-text bg-light"><i class="fas fa-globe text-primary"></i></span>
                            </div>
                            <input type="url" name="{{ form.website.name }}" id="{{ form.website.id_for_label }}" 
                                   class="form-control {% if form.website.errors %}is-invalid{% endif %}" 
                                   value="{{ form.website.value|default:'' }}" placeholder="https://www.kompanija.rs">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Ostale lokacije -->
                <div class="card card-info card-outline shadow-sm">
                  <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h3 class="card-title"><i class="fas fa-building"></i> Ostale lokacije</h3>
                    {% if object and object.id %}
                    <div class="card-tools">
                      <a href="{% url 'company:location_create' %}?company={{ object.id }}" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-plus"></i> Nova lokacija
                      </a>
                    </div>
                    {% endif %}
                  </div>
                  <div class="card-body">
                    {% if object and object.locations.exists %}
                    <div class="table-responsive">
                      <table class="table table-striped table-hover">
                        <thead class="thead-light">
                          <tr>
                            <th>Naziv</th>
                            <th>Adresa</th>
                            <th>Grad</th>
                            <th>Akcije</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for location in object.locations.all %}
                          <tr>
                            <td><strong>{{ location.name }}</strong></td>
                            <td>
                              {% if location.full_address %}
                                {{ location.full_address }}
                              {% else %}
                                <span class="text-muted">Nije uneto</span>
                              {% endif %}
                            </td>
                            <td>{{ location.city|default:"Nije uneto" }}</td>
                            <td>
                              <div class="btn-group">
                                <a href="{% url 'company:location_detail' location.id %}" class="btn btn-info btn-sm" title="Detalji">
                                  <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'company:location_update' location.id %}" class="btn btn-warning btn-sm" title="Izmeni">
                                  <i class="fas fa-edit"></i>
                                </a>
                                <a href="{% url 'company:location_delete' location.id %}" class="btn btn-danger btn-sm" title="Obriši">
                                  <i class="fas fa-trash"></i>
                                </a>
                              </div>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                      <i class="fas fa-info-circle"></i> Nema dodatnih lokacija.
                      {% if object and object.id %}
                      <a href="{% url 'company:location_create' %}?company={{ object.id }}" class="btn btn-info btn-sm ml-2">
                        <i class="fas fa-plus"></i> Dodaj prvu lokaciju
                      </a>
                      {% else %}
                      <p>Sačuvajte kompaniju prvo da biste mogli dodati lokacije.</p>
                      {% endif %}
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
              
              <!-- Tab: Kontakti -->
              <div class="tab-pane fade" id="contacts" role="tabpanel" aria-labelledby="contacts-tab">
                <div class="row">
                  <div class="col-12">
                    <div class="card card-primary card-outline">
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="card-title"><i class="fas fa-address-book"></i> Kontakt osobe</h3>
                        {% if object and object.id %}
                        <div class="card-tools">
                          <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addContactModal">
                            <i class="fas fa-plus"></i> Nova kontakt osoba
                          </button>
                        </div>
                        {% endif %}
                      </div>
                      <div class="card-body">
                        {% if object and object.kontakt_osobe.exists %}
                          <div class="table-responsive">
                            <table class="table table-striped table-hover">
                              <thead class="thead-light">
                                <tr>
                                  <th>Ime i prezime</th>
                                  <th>Pozicija</th>
                                  <th>Email</th>
                                  <th>Telefon</th>
                                  <th>Status</th>
                                  <th>Akcije</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for contact in object.kontakt_osobe.all %}
                                  <tr {% if contact.is_primary %} class="table-primary"{% endif %}>
                                    <td><strong>{{ contact.ime_prezime }}</strong></td>
                                    <td>{{ contact.pozicija|default:"-" }}</td>
                                    <td>{% if contact.email %}<a href="mailto:{{ contact.email }}">{{ contact.email }}</a>{% else %}-{% endif %}</td>
                                    <td>{{ contact.telefon|default:"-" }}</td>
                                    <td>{% if contact.is_primary %}<span class="badge badge-primary">Primarni kontakt</span>{% endif %}</td>
                                    <td>
                                      <div class="btn-group">
                                        <button type="button" class="btn btn-warning btn-sm edit-contact" 
                                                data-contact-id="{{ contact.id }}" 
                                                data-contact-name="{{ contact.ime_prezime }}" 
                                                data-contact-position="{{ contact.pozicija|default:'' }}" 
                                                data-contact-email="{{ contact.email|default:'' }}" 
                                                data-contact-phone="{{ contact.telefon|default:'' }}" 
                                                data-contact-primary="{{ contact.is_primary|yesno:'true,false' }}">
                                          <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-danger btn-sm delete-contact" 
                                                data-contact-id="{{ contact.id }}" 
                                                data-contact-name="{{ contact.ime_prezime }}">
                                          <i class="fas fa-trash"></i>
                                        </button>
                                      </div>
                                    </td>
                                  </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                          </div>
                        {% else %}
                          <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Nema kontakt osoba.
                            {% if object and object.id %}
                              <button type="button" class="btn btn-primary btn-sm ml-2" data-toggle="modal" data-target="#addContactModal">
                                <i class="fas fa-plus"></i> Dodaj prvu kontakt osobu
                              </button>
                            {% else %}
                              <p>Sačuvajte kompaniju prvo da biste mogli dodati kontakt osobe.</p>
                            {% endif %}
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Tab: Provere i Auditi -->
              <div class="tab-pane fade" id="audits" role="tabpanel" aria-labelledby="audits-tab">
                <div class="row">
                  <div class="col-12">
                    <div class="card card-primary card-outline">
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="card-title"><i class="fas fa-clipboard-check"></i> Ciklusi Sertifikacije</h3>
                        {% if object and object.id %}
                        <div class="card-tools">
                          <a href="{% url 'company:company_cycle_create' object.id %}" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus"></i> Novi Ciklus Sertifikacije
                          </a>
                        </div>
                        {% endif %}
                      </div>
                      <div class="card-body">
                        {% if object and object.id %}
                          <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Cikluse sertifikacije možete dodati nakon što sačuvate osnovne podatke o kompaniji.
                            <a href="{% url 'company:company_cycle_create' object.id %}" class="btn btn-primary btn-sm ml-2">
                              <i class="fas fa-plus"></i> Dodaj ciklus sertifikacije
                            </a>
                          </div>
                        {% else %}
                          <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Sačuvajte kompaniju prvo da biste mogli dodati cikluse sertifikacije.
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Tab: Sastanci -->
              <div class="tab-pane fade" id="meetings" role="tabpanel" aria-labelledby="meetings-tab">
                <div class="row">
                  <div class="col-12">
                    <div class="card card-primary card-outline">
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="card-title"><i class="fas fa-calendar-alt"></i> Sastanci i Termini</h3>
                        {% if object and object.id %}
                        <div class="card-tools">
                          <a href="{% url 'company:calendar' %}" class="btn btn-primary btn-sm">
                            <i class="fas fa-calendar"></i> Svi sastanci
                          </a>
                        </div>
                        {% endif %}
                      </div>
                      <div class="card-body">
                        {% if object and object.id %}
                          <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Sastanke možete dodati nakon što sačuvate osnovne podatke o kompaniji.
                            <a href="{% url 'company:calendar' %}" class="btn btn-primary btn-sm ml-2">
                              <i class="fas fa-calendar-plus"></i> Dodaj novi sastanak
                            </a>
                          </div>
                        {% else %}
                          <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Sačuvajte kompaniju prvo da biste mogli dodati sastanke.
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Tab: IAF/EAC Kodovi -->
              <div class="tab-pane fade" id="iaf" role="tabpanel" aria-labelledby="iaf-tab">
                <h5 class="mb-3">IAF/EAC Kodovi</h5>
                <div class="card">
                  <div class="card-body">
                    <div class="table-responsive mb-4">
                      <table class="table table-sm table-striped table-hover">
                        <thead class="thead-light">
                          <tr>
                            <th width="15%">IAF/EAC kod</th>
                            <th width="40%">Opis</th>
                            <th width="15%">Status</th>
                            <th width="15%">Napomena</th>
                            <th width="15%">Akcije</th>
                          </tr>
                        </thead>
                        <tbody id="iaf-eac-codes-list" data-company-id="{{ object.id|default:0 }}">
                          <!-- JavaScript će dinamički popuniti tabelu sa IAF/EAC kodovima -->
                        </tbody>
                      </table>
                    </div>
                    <div class="alert alert-info" id="no-iaf-codes-message" style="display: none;">
                      <i class="fas fa-info-circle"></i> Kompaniji nisu dodeljeni IAF/EAC kodovi. Dodajte kodove ispod.
                    </div>

                    <div class="row">
                      <div class="col-md-5">
                        <div class="form-group">
                          <label for="iaf_eac_code_select">Izaberite IAF/EAC kod</label>
                          <select id="iaf_eac_code_select" class="form-control">
                            <option value="">-- Izaberite kod --</option>
                            {% for code in all_iaf_eac_codes %}
                              <option value="{{ code.id }}" data-description="{{ code.description }}">
                                {{ code.iaf_code }} - {{ code.description|truncatechars:50 }}
                              </option>
                            {% endfor %}
                          </select>
                        </div>
                      </div>
                      <div class="col-md-5">
                        <div class="form-group">
                          <label for="iaf_eac_code_notes">Napomena</label>
                          <input type="text" id="iaf_eac_code_notes" class="form-control" placeholder="Unesite napomenu (opciono)">
                        </div>
                      </div>
                      <div class="col-md-2">
                        <div class="form-group">
                          <label for="iaf_eac_is_primary" class="d-block">Primarni</label>
                          <div class="form-check">
                            <input type="checkbox" id="iaf_eac_is_primary" class="form-check-input">
                            <label class="form-check-label" for="iaf_eac_is_primary">Postavi kao primarni</label>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="form-group">
                      {% if object and object.id %}
                        <!-- Debug informacije o ID-u kompanije -->
                        <div class="small text-muted mb-2">ID kompanije: {{ object.id }}</div>
                      {% endif %}
                      
                      <button type="button" class="btn btn-success" id="addIafEacButton" data-company-id="{{ object.id|default:0 }}">
                        <i class="fas fa-plus"></i> Dodaj IAF/EAC kod
                      </button>
                    </div>
                    
                    <!-- Skriveno polje za IAF/EAC kodove -->
                    <input type="hidden" name="iaf_eac_codes_data" id="iaf_eac_codes_data" value="">
                  </div>
                </div>
              </div>
              
              <!-- Tab za napomene je uklonjen -->
            </div>
            
            <div class="form-group mt-4">
              <!-- Direktno submit dugme za čuvanje podataka -->
              <button type="button" class="btn btn-primary" id="saveCompanyButton">
                <i class="fas fa-save"></i> {{ submit_text|default:'Sačuvaj izmene' }}
              </button>
              
              <!-- JavaScript za rukovanje dugmetom za čuvanje -->
              <script>
                document.addEventListener('DOMContentLoaded', function() {
                  var saveButton = document.getElementById('saveCompanyButton');
                  if (saveButton) {
                    saveButton.addEventListener('click', function() {
                      try {
                        console.log('Dugme "Sačuvaj izmene" kliknuto!');
                        var form = document.querySelector('form[method="post"]');
                        console.log('Forma pronađena:', !!form);
                        
                        if (form) {
                          // Prikaži indikator učitavanja na dugmetu
                          var originalText = this.innerHTML;
                          this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Čuvam podatke...';
                          this.disabled = true;
                          
                          // Direktno šalji formu
                          console.log('Direktno šaljem formu...');
                          
                          // Dodaj skriveno polje za označavanje da je forma poslata preko dugmeta
                          var hiddenInput = document.createElement('input');
                          hiddenInput.type = 'hidden';
                          hiddenInput.name = 'form_submitted_via_button';
                          hiddenInput.value = 'true';
                          form.appendChild(hiddenInput);
                          
                          // Šalji formu
                          form.submit();
                          
                          // Ako uspešno pošalje, dodajemo event za kada se stranica vrati nakon slanja
                          // URL će imati ?success=true ako je backend dodao taj parametar
                          localStorage.setItem('company_form_submitted', 'true');
                        } else {
                          // Prikaži grešku ako forma nije pronađena
                          if (typeof window.showDirectModal === 'function') {
                            window.showDirectModal(
                              'Greška',
                              'Forma nije pronađena!',
                              'error'
                            );
                          } else {
                            alert('Forma nije pronađena!');
                          }
                          this.disabled = false;
                        }
                      } catch(e) {
                        console.error('Greška pri slanju forme:', e);
                        if (typeof window.showDirectModal === 'function') {
                          window.showDirectModal(
                            'Greška',
                            'Došlo je do greške: ' + e.message,
                            'error'
                          );
                        } else {
                          alert('Greška: ' + e.message);
                        }
                        
                        // Vrati dugme u prvobitno stanje
                        this.innerHTML = originalText;
                        this.disabled = false;
                      }
                    });
                  }
                  
                  // Proveri da li je forma upravo poslata i prikaži poruku o uspehu ako jeste
                  if (localStorage.getItem('company_form_submitted') === 'true') {
                    console.log('Forma je uspešno poslata, prikazujem poruku o uspehu');
                    // Izbriši marker
                    localStorage.removeItem('company_form_submitted');
                    
                    // Funkcija za prikazivanje poruke o uspehu
                    var showSuccessMessage = function() {
                      if (typeof window.showDirectModal === 'function') {
                        window.showDirectModal(
                          'Uspešno sačuvano',
                          'Podaci o kompaniji su uspešno sačuvani.',
                          'success'
                        );
                      } else {
                        console.warn('showDirectModal funkcija nije dostupna');
                      }
                    };
                    
                    // Pokušaj odmah prikazati poruku
                    showSuccessMessage();
                    
                    // Ako nije uspelo, pokušaj ponovo nakon kratkog odlaganja
                    setTimeout(showSuccessMessage, 500);
                    
                    // I još jednom nakon dužeg odlaganja za svaki slučaj
                    setTimeout(showSuccessMessage, 1000);
                  }
                });
              </script>

              <a href="{% url 'company:list' %}" class="btn btn-secondary ml-2">
                <i class="fas fa-times"></i> Otkaži
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
{% load static %}
<!-- Uključi eksterne JavaScript datoteke -->  
<script src="{% static 'js/company/company-form.js' %}"></script>
<script src="{% static 'js/company/company-form-submit.js' %}"></script>
<script src="{% static 'js/company/form-direct-submit.js' %}"></script>
  <!-- Pripremi podatke za JS -->
{% load static %}
<script>

  // Dodavanje skrivenog polja za čuvanje podataka o obrisanim standardima
  if (!$('#deleted_standards').length) {
    $('form').append('<input type="hidden" id="deleted_standards" name="deleted_standards" value="[]">');
  }

  // Funkcija za pripremu podataka o standardima za slanje forme
  function prepareStandardsData() {
    $('#standards_data').val(JSON.stringify(standardsData));
  }

  // Funkcija za formatiranje datuma za prikaz
  function formatDateDisplay(dateStr) {
    if (!dateStr) return '-';
    var date = new Date(dateStr);
    return ('0' + date.getDate()).slice(-2) + '.' + ('0' + (date.getMonth() + 1)).slice(-2) + '.' + date.getFullYear() + '.';
  }

    // Funkcija za osvežavanje prikaza tabele standarda
    function updateStandardsTable() {
      var tableBody = $('#standards-list');
      var noStandardsMessage = $('#no-standards-message');
      
      if (standardsData.length === 0) {
        tableBody.html('');
        noStandardsMessage.show();
        return;
      }
      
      noStandardsMessage.hide();
      
      var html = '';
      for (var i = 0; i < standardsData.length; i++) {
        var item = standardsData[i];
        var rowId = item.standard_id ? 'standard-' + item.standard_id : 'new-standard-' + i;
        
        html += '<tr id="' + rowId + '">' +
                '<td><strong>' + item.name + '</strong></td>' +
                '<td>' + formatDisplayDate(item.issue_date) + '</td>' +
                '<td>' + formatDisplayDate(item.expiry_date) + '</td>' +
                '<td>' + (item.notes || '-') + '</td>' +
                '<td>' +
                  '<div class="btn-group btn-group-sm">' +
                    '<button type="button" class="btn btn-outline-danger btn-remove-standard" data-index="' + i + '">' +
                      '<i class="fas fa-trash"></i>' +
                    '</button>' +
                  '</div>' +
                '</td>' +
              '</tr>';
      }
      
      tableBody.html(html);
      
      // Dodajemo event listener za brisanje standarda
      $('.btn-remove-standard').off('click').on('click', function() {
        var index = $(this).data('index');
        standardsData.splice(index, 1);
        updateStandardsTable();
      });
    }

    // Funkcija za dodavanje novog standarda
    function addStandard() {
      var standardSelect = $('#standard_definition_select');
      var standardId = standardSelect.val();
      
      if (!standardId) {
        alert('Molimo izaberite standard');
        return;
      }

      // Provera da li standard već postoji
      for (var i = 0; i < standardsData.length; i++) {
        if (standardsData[i].id == standardId) {
          alert('Ovaj standard je već dodat!');
          return;
        }
      }
      
      var standardText = standardSelect.find('option:selected').text().trim();
      var issueDate = $('#standard_issue_date').val() || '';
      var expiryDate = $('#standard_expiry_date').val() || '';
      var notes = $('#standard_notes').val() || '';
      
      // Dodajemo novi standard u listu
      standardsData.push({
        id: parseInt(standardId),
        name: standardText,
        issue_date: issueDate,
        expiry_date: expiryDate,
        notes: notes
      });
      
      // Osvežavamo prikaz tabele
      updateStandardsTable();
      
      // Resetujemo polja forme
      standardSelect.val('');
      $('#standard_issue_date').val('');
      $('#standard_expiry_date').val('');
      $('#standard_notes').val('');
    }

    // Event handler za dodavanje standarda na klik dugmeta
    $('#add-standard').off('click').on('click', function(e) {
      e.preventDefault();
      addStandard();
    });

    // Postavljamo event handler za submit forme da pripremi podatke o standardima
    $('form').on('submit', function() {
      prepareStandardsData();
    });

    // Inicijalno osvežavanje tabele standarda
    updateStandardsTable();
    // IAF/EAC kodovi se učitavaju iz posebne JS datoteke
</script>

<!-- Modal za potvrdu brisanja standarda -->
<div class="modal fade" id="deleteStandardModal" tabindex="-1" role="dialog" aria-labelledby="deleteStandardModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger">
        <h5 class="modal-title" id="deleteStandardModalLabel">Potvrda brisanja standarda</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Da li ste sigurni da želite da obrišete standard <strong id="standardToDeleteName"></strong>?</p>
        <input type="hidden" id="standardToDeleteId" name="standardToDeleteId" value="">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Otkaži</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteStandard">Obriši</button>
      </div>
    </div>
  </div>
</div>

<!-- Koristićemo lokalne biblioteke koje sada poslužuje Nginx sa ispravnim MIME tipovima -->

<!-- Inicijalizacija modalnih dijaloga i Select2 komponente -->
<script>
  $(document).ready(function() {
    // Inicijalizacija Select2 komponente za izbor auditora
    $('#auditors').select2({
      theme: 'bootstrap4',
      placeholder: 'Izaberite auditore...',
      allowClear: true,
      width: '100%'
    });
    
    // Osiguraj da modalni dijalozi budu pravilno inicijalzovani
    $('#deleteStandardModal').modal({
      show: false, // Ne prikazuj automatski
      backdrop: 'static' // Spreči zatvaranje klikom van modala
    });
    
    console.log('Modal dialog initialized:', $('#deleteStandardModal').length > 0);
    console.log('Select2 initialized for auditors');
    
    // Handler za direktno dodavanje standarda
    $('#directStandardAdd').off('click').on('click', function() {
      // Validacija forme pre slanja
      var standardId = $('#standard_definition').val();
      if (!standardId) {
        alert('Morate izabrati standard!');
        return false;
      }
      
      // Pošalji formu
      $('#standardAddForm').submit();
    });
    
    // Handler za dugme za brisanje standarda
    $('#standards-list').off('click', '.btn-remove-standard').on('click', '.btn-remove-standard', function() {
      var standardId = $(this).data('id');
      var standardName = $(this).closest('tr').find('td:first-child strong').text();
      console.log('Clicked remove button, standardId:', standardId);
      console.log('Standard name:', standardName);
      
      // Postavi vrednosti u modalni dijalog
      $('#standardToDeleteName').text(standardName);
      $('#standardToDeleteId').val(standardId);
      
      // Prikaži modalni dijalog
      $('#deleteStandardModal').modal('show');
    });
    
    // Handler za potvrdu brisanja standarda
    $('#confirmDeleteStandard').off('click').on('click', function() {
      var standardId = $('#standardToDeleteId').val();
      console.log('Confirming deletion of standard ID:', standardId);
      
      // Dobavi CSRF token iz dokumenta
      var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
      
      // Pošalji AJAX zahtev za brisanje standarda
      $.ajax({
        url: '{% url "company:delete_standard" %}',
        type: 'POST',
        data: {
          'standard_id': standardId,
          'csrfmiddlewaretoken': csrfToken
        },
        success: function(response) {
          console.log('Standard successfully deleted:', response);
          
          // Sakrij modalni dijalog
          $('#deleteStandardModal').modal('hide');
          
          // Ukloni red iz tabele
          $('#standard-' + standardId).remove();
          
          // Prikaži poruku o uspešnom brisanju
          toastr.success('Standard je uspešno obrisan.');
        },
        error: function(xhr, status, error) {
          console.error('Error deleting standard:', error);
          
          // Sakrij modalni dijalog
          $('#deleteStandardModal').modal('hide');
          
          // Prikaži poruku o grešci
          toastr.error('Došlo je do greške pri brisanju standarda.');
        }
      });
    });
  });
</script>

<!-- Modal za potvrdu brisanja standarda -->
<div class="modal fade" id="deleteStandardModal" tabindex="-1" role="dialog" aria-labelledby="deleteStandardModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteStandardModalLabel">Potvrda brisanja standarda</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Da li ste sigurni da želite da obrišete standard <strong id="standardNameToDelete"></strong>?</p>
        <p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Ova akcija je nepovratna!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Odustani</button>
        <form id="deleteStandardForm" method="post" action="">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Obriši</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal za potvrdu brisanja standarda -->
<div class="modal fade" id="deleteStandardModal" tabindex="-1" role="dialog" aria-labelledby="deleteStandardModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteStandardModalLabel">Potvrda brisanja standarda</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Da li ste sigurni da želite da obrišete standard <strong id="standardNameToDelete"></strong>?</p>
        <p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Ova akcija je nepovratna!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Odustani</button>
        <form id="deleteStandardForm" method="post" action="">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Obriši</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modali za uspeh i greške pri radu sa standardima -->
{% include 'company/standard-success-modal.html' %}
{% include 'company/standard-validation-modal.html' %}

{% endblock %}

{% block extra_scripts %}
{% load static %}
<!-- Učitavanje Select2 biblioteke -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- Privremeno ugrađene JavaScript funkcije umesto eksternih fajlova dok ne rešimo problem sa statičkim fajlovima -->
<script>
/**
 * Direct Modal - Direktna implementacija modala bez zavisnosti
 */
(function() {
    'use strict';
    
    // Kreiranje modala direktno u DOM-u, bez zavisnosti od Bootstrap-a
    function showDirectModal(title, message, type) {
        console.log('Prikazujem direktni modal:', title, message, type);
        
        // Ukloni postojeći modal ako postoji
        removeExistingModal();
        
        // Određivanje klase za tip modala
        var headerClass;
        var iconClass;
        
        switch(type) {
            case 'success':
                headerClass = 'bg-success';
                iconClass = 'fa-check-circle text-success';
                break;
            case 'error':
                headerClass = 'bg-danger';
                iconClass = 'fa-exclamation-circle text-danger';
                break;
            case 'warning':
                headerClass = 'bg-warning';
                iconClass = 'fa-exclamation-triangle text-warning';
                break;
            default:
                headerClass = 'bg-info';
                iconClass = 'fa-info-circle text-info';
        }
        
        // Kreiranje HTML-a za modal
        var modalHTML = `
            <div id="directModal" class="modal" style="display: block; background-color: rgba(0,0,0,0.5); position: fixed; top: 0; left: 0; z-index: 9999; width: 100%; height: 100%; overflow: auto; padding-top: 100px;">
                <div class="modal-dialog" style="max-width: 500px; margin: 30px auto; position: relative;">
                    <div class="modal-content" style="border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,.5);">
                        <div class="modal-header ${headerClass}" style="padding: 15px; border-bottom: 1px solid #e5e5e5; border-radius: 5px 5px 0 0; color: white;">
                            <h5 class="modal-title" style="margin: 0; line-height: 1.42857143;">${title}</h5>
                            <button type="button" class="close" onclick="window.closeDirectModal()" style="background: transparent; border: 0; font-size: 21px; font-weight: 700; opacity: .5; padding: 0; cursor: pointer; float: right;">
                                <span>×</span>
                            </button>
                        </div>
                        <div class="modal-body" style="padding: 15px;">
                            <div style="text-align: center; margin-bottom: 15px;">
                                <i class="fas ${iconClass}" style="font-size: 3rem;"></i>
                            </div>
                            <p style="text-align: center;">${message}</p>
                        </div>
                        <div class="modal-footer" style="padding: 15px; text-align: right; border-top: 1px solid #e5e5e5; border-radius: 0 0 5px 5px;">
                            <button type="button" class="btn btn-primary" onclick="window.closeDirectModal()" style="display: inline-block; margin-bottom: 0; font-weight: 400; text-align: center; white-space: nowrap; vertical-align: middle; -ms-touch-action: manipulation; touch-action: manipulation; cursor: pointer; background-image: none; border: 1px solid transparent; padding: 6px 12px; font-size: 14px; line-height: 1.42857143; border-radius: 4px; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; color: #fff; background-color: #007bff; border-color: #007bff;">U redu</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Dodavanje modala u DOM
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Fokusiranje na "U redu" dugme
        setTimeout(function() {
            var okButton = document.querySelector('#directModal .btn-primary');
            if (okButton) {
                okButton.focus();
            }
        }, 100);
        
        console.log('Direktni modal kreiran i prikazan.');
    }
    
    // Funkcija za zatvaranje modala
    function closeDirectModal() {
        console.log('Zatvaranje direktnog modala.');
        removeExistingModal();
    }
    
    // Pomoćna funkcija za uklanjanje postojećeg modala
    function removeExistingModal() {
        var existingModal = document.getElementById('directModal');
        if (existingModal) {
            existingModal.parentNode.removeChild(existingModal);
        }
    }
    
    // Postavljanje funkcija u globalni opseg da budu dostupne
    window.showDirectModal = showDirectModal;
    window.closeDirectModal = closeDirectModal;
})();

/**
 * IAF-EAC Handler - Objedinjeni modul za rukovanje IAF/EAC kodovima
 */
(function($) {
    'use strict';
    
    // Inicijalizacija
    $(document).ready(function() {
        console.log('Inicijalizacija IAF/EAC handlera...');
        console.log('Provera da li postoji dugme za dodavanje:', $('#addIafEacButton').length);
        console.log('Provera da li je showDirectModal funkcija dostupna:', typeof window.showDirectModal === 'function');
        
        // Provera da li je csrfToken dostupan
        var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
        console.log('CSRF token dostupan:', csrfToken ? 'Da' : 'Ne');
        
        initAddButton();
        initDeleteButtons();
        initPrimaryButtons();
    });
    
    // Inicijalizacija dugmeta za dodavanje
    function initAddButton() {
        console.log('Inicijalizacija dugmeta za dodavanje IAF/EAC koda...');
        
        // Direktno dodavanje event listenera umesto jQuery metode
        var addButton = document.getElementById('addIafEacButton');
        if (addButton) {
            console.log('Dodavanje click event listenera na dugme...');
            addButton.addEventListener('click', handleAddButtonClick);
        } else {
            console.error('Dugme za dodavanje IAF/EAC koda nije pronađeno u DOM-u!');
        }
        
        // Dodavanje i putem jQuery za svaki slučaj
        $('#addIafEacButton').on('click', function(e) {
            console.log('jQuery onClick handler za addIafEacButton aktiviran!');
            e.preventDefault();
            handleAddButtonClick(e);
        });
    }
    
    // Handler funkcija za klik na dugme za dodavanje
    function handleAddButtonClick(e) {
        console.log('Kliknuto je dugme za dodavanje IAF/EAC koda!', e);
        if (e && e.preventDefault) e.preventDefault();
        
        var $btn = $('#addIafEacButton');
        var companyId = $btn.data('company-id');
        console.log('ID kompanije:', companyId);
        
        // Validacija
        var iafEacCodeId = $('#iaf_eac_code_select').val();
        if (!iafEacCodeId) {
            showMessage('Potrebna validacija', 'Morate izabrati IAF/EAC kod pre nego što nastavite.', 'warning');
            $('#iaf_eac_code_select').focus();
            return;
        }
        
        // Proverimo da li je ID kompanije validan
        if (!companyId || companyId === '0' || companyId === 0) {
            console.error('ID kompanije nije validan:', companyId);
            showMessage('Greška', 'ID kompanije nije validan. Ne možemo dodati IAF/EAC kod.', 'error');
            return;
        }
        
        console.log('ID kompanije je validan:', companyId);
        
        // Prikupljanje podataka
        var notes = $('#iaf_eac_code_notes').val();
        var isPrimary = $('#iaf_eac_is_primary').is(':checked');
        var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
        
        // UI ažuriranje
        var originalBtnText = $btn.html();
        $btn.html('<i class="fas fa-spinner fa-spin"></i> Dodajem...');
        $btn.prop('disabled', true);
        
        // Dodatna provera za ispravnost CSRF tokena
        if (!csrfToken) {
            console.error('CSRF token nije dostupan!');
            showMessage('Greška', 'CSRF token nije dostupan. Osvežite stranicu i pokušajte ponovo.', 'error');
            $btn.html(originalBtnText);
            $btn.prop('disabled', false);
            return;
        }
        
        console.log('Pripremam AJAX poziv...');
        
        // Isprobajmo više URL-ova dok ne pronađemo ispravan
        var urls = [
            '/companies/' + companyId + '/iaf-eac/add/',
            '/company/companies/' + companyId + '/iaf-eac/add/',
            '/company/api/iaf-eac/add/' // Dodatni URL za testiranje
        ];
        
        // Podaci koji se šalju
        var data = {
            'iaf_eac_code': iafEacCodeId,
            'notes': notes,
            'is_primary': isPrimary,
            'csrfmiddlewaretoken': csrfToken
        };
        console.log('Podaci koji se šalju:', data);
        
        // Funkcija za izvršavanje AJAX poziva sa sledećim URL-om ako trenutni ne uspe
        function tryAjaxWithUrl(urlIndex) {
            if (urlIndex >= urls.length) {
                console.error('Svi URL-ovi su isprobani i nijedan nije uspeo');
                $btn.html(originalBtnText);
                $btn.prop('disabled', false);
                showMessage('Greška pri dodavanju IAF/EAC koda', 'Nijedan URL nije pronađen. Kontaktirajte administratora.', 'error');
                return;
            }
            
            var currentUrl = urls[urlIndex];
            console.log('Pokušavam sa URL-om:', currentUrl);
            
            // AJAX poziv
            $.ajax({
                url: currentUrl,
                type: 'POST',
                data: data,
                success: function(response) {
                    console.log('AJAX poziv uspešan!', response);
                    
                    // Čišćenje forme
                    $('#iaf_eac_code_select').val('');
                    $('#iaf_eac_code_notes').val('');
                    $('#iaf_eac_is_primary').prop('checked', false);
                    
                    // Poruka o uspehu
                    var codeName = $('#iaf_eac_code_select option:selected').text() || 'Odabrani kod';
                    showMessage('IAF/EAC kod uspešno dodat', 
                                'IAF/EAC kod "' + codeName + '" je uspešno dodat kompaniji!', 
                                'success');
                    
                    // Osvežavanje stranice
                    setTimeout(function() {
                        window.location.reload();
                    }, 1500);
                },
                error: function(xhr, status, error) {
                    console.error('AJAX greška za URL ' + currentUrl + ':', status, error);
                    console.log('Status kod:', xhr.status);
                    
                    // Ako je 404, probaj sledeći URL
                    if (xhr.status === 404) {
                        console.log('Probavam sledeći URL...');
                        tryAjaxWithUrl(urlIndex + 1);
                    } else {
                        // Resetovanje dugmeta
                        $btn.html(originalBtnText);
                        $btn.prop('disabled', false);
                        
                        // Poruka o grešci
                        var errorMsg = 'Došlo je do greške pri dodavanju IAF/EAC koda.';
                        if (xhr.status) {
                            errorMsg += ' (Status kod: ' + xhr.status + ')';
                        }
                        
                        showMessage('Greška pri dodavanju IAF/EAC koda', errorMsg, 'error');
                    }
                }
            });
        }
        
        // Početak AJAX pokušaja
        tryAjaxWithUrl(0);
    }
    
    // Inicijalizacija dugmeta za brisanje
    function initDeleteButtons() {
        // Koristimo delegirani event handling za dinamički generisane elemente
        // Ovo osigurava da će event listener raditi i na novo dodatim elementima
        $(document).off('click', '.delete-iaf-eac-btn').on('click', '.delete-iaf-eac-btn', function(e) {
            e.preventDefault();
            console.log('Kliknuto dugme za brisanje IAF/EAC koda');
            
            var $btn = $(this);
            var codeId = $btn.data('code-id');
            var codeName = $btn.data('code-name');
            var companyId = $btn.data('company-id');
            
            console.log('Podaci za brisanje:', {
                codeId: codeId,
                codeName: codeName,
                companyId: companyId
            });
            
            // Kreirajmo sopstveni modal za potvrdu brisanja umesto standardnog confirm dijaloga
            console.log('Kreiram sopstveni modal za potvrdu brisanja');
            
            // Kreira modal za potvrdu direktno u DOM-u
            var confirmModalHTML = `
                <div id="confirmDeleteModal" class="modal" style="display: block; background-color: rgba(0,0,0,0.5); position: fixed; top: 0; left: 0; z-index: 9999; width: 100%; height: 100%; overflow: auto; padding-top: 100px;">
                    <div class="modal-dialog" style="max-width: 500px; margin: 30px auto; position: relative;">
                        <div class="modal-content" style="border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,.5);">
                            <div class="modal-header bg-danger" style="padding: 15px; border-bottom: 1px solid #e5e5e5; border-radius: 5px 5px 0 0; color: white;">
                                <h5 class="modal-title" style="margin: 0; line-height: 1.42857143;">Potvrda brisanja</h5>
                                <button type="button" class="close cancel-delete" style="background: transparent; border: 0; font-size: 21px; font-weight: 700; opacity: .5; padding: 0; cursor: pointer; float: right;">
                                    <span>×</span>
                                </button>
                            </div>
                            <div class="modal-body" style="padding: 15px;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <i class="fas fa-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                                </div>
                                <p style="text-align: center;">Da li ste sigurni da želite da obrišete IAF/EAC kod "${codeName}"?</p>
                                <p class="text-danger" style="text-align: center;"><strong>Ova akcija je nepovratna!</strong></p>
                            </div>
                            <div class="modal-footer" style="padding: 15px; text-align: right; border-top: 1px solid #e5e5e5; border-radius: 0 0 5px 5px;">
                                <button type="button" class="btn btn-secondary cancel-delete mr-2" style="display: inline-block; margin-bottom: 0; font-weight: 400; text-align: center; white-space: nowrap; vertical-align: middle; cursor: pointer; background-image: none; border: 1px solid transparent; padding: 6px 12px; font-size: 14px; line-height: 1.42857143; border-radius: 4px; color: #fff; background-color: #6c757d; border-color: #6c757d; margin-right: 10px;">Odustani</button>
                                <button type="button" class="btn btn-danger confirm-delete" style="display: inline-block; margin-bottom: 0; font-weight: 400; text-align: center; white-space: nowrap; vertical-align: middle; cursor: pointer; background-image: none; border: 1px solid transparent; padding: 6px 12px; font-size: 14px; line-height: 1.42857143; border-radius: 4px; color: #fff; background-color: #dc3545; border-color: #dc3545;">Obriši</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Dodavanje modala u DOM
            document.body.insertAdjacentHTML('beforeend', confirmModalHTML);
            
            // Dodavanje event listener-a za dugmad
            $('.cancel-delete').on('click', function() {
                $('#confirmDeleteModal').remove();
            });
            
            $('.confirm-delete').on('click', function() {
                // Uklanjanje modala
                $('#confirmDeleteModal').remove();
                
                // Nastavak sa brisanjem
                var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
                var originalBtnHtml = $btn.html();
                
                // Prikaži indikator učitavanja
                $btn.html('<i class="fas fa-spinner fa-spin"></i>');
                $btn.prop('disabled', true);
                
                // Pokušaj sa više URL-ova
                var urls = [
                    '/company/companies/' + companyId + '/iaf-eac/' + codeId + '/delete/',
                    '/companies/' + companyId + '/iaf-eac/' + codeId + '/delete/',
                    '/company/api/iaf-eac/delete/'
                ];
                
                function tryDeleteWithUrl(urlIndex) {
                    if (urlIndex >= urls.length) {
                        console.error('Svi URL-ovi su isprobani i nijedan nije uspeo');
                        $btn.html(originalBtnHtml);
                        $btn.prop('disabled', false);
                        alert('Došlo je do greške pri brisanju IAF/EAC koda. Nijedan URL nije pronađen.');
                        return;
                    }
                    
                    var currentUrl = urls[urlIndex];
                    var data = {
                        'csrfmiddlewaretoken': csrfToken
                    };
                    
                    // Dodaj code_id ako koristimo API putanju
                    if (currentUrl.includes('/api/')) {
                        data.code_id = codeId;
                    }
                    
                    console.log('Pokušavam brisanje sa URL-om:', currentUrl);
                    
                    $.ajax({
                        url: currentUrl,
                        type: 'POST',
                        data: data,
                        success: function(response) {
                            console.log('IAF/EAC kod uspešno obrisan!', response);
                            showMessage('Uspešno brisanje', 'IAF/EAC kod je uspešno obrisan!', 'success');
                            
                            // Osvežavanje stranice ili samo uklanjanje reda iz tabele
                            setTimeout(function() {
                                // Umesto osvežavanja stranice, ukloni red iz tabele
                                $btn.closest('tr').fadeOut(300, function() {
                                    $(this).remove();
                                    
                                    // Proveri da li ima još kodova
                                    if ($('#iaf-eac-codes-list tr').length === 0) {
                                        $('#no-iaf-codes-message').show();
                                    }
                                });
                            }, 500);
                        },
                        error: function(xhr, status, error) {
                            console.error('Greška pri brisanju IAF/EAC koda:', status, error);
                            console.log('Status kod:', xhr.status);
                            
                            // Ako je 404, probaj sledeći URL
                            if (xhr.status === 404) {
                                console.log('Probavam sledeći URL...');
                                tryDeleteWithUrl(urlIndex + 1);
                            } else {
                                // Resetovanje dugmeta
                                $btn.html(originalBtnHtml);
                                $btn.prop('disabled', false);
                                showMessage('Greška', 'Došlo je do greške pri brisanju IAF/EAC koda.', 'error');
                            }
                        }
                    });
                }
                
                // Počni sa prvim URL-om
                tryDeleteWithUrl(0);
            });
            
        });
    }
    
    // Inicijalizacija dugmeta za postavjanje primarnog koda
    function initPrimaryButtons() {
        $(document).on('click', '.set-primary-iaf-eac-btn', function(e) {
            e.preventDefault();
            var $btn = $(this);
            var codeId = $btn.data('code-id');
            var companyId = $btn.data('company-id');
            var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
            
            // UI ažuriranje
            $btn.html('<i class="fas fa-spinner fa-spin"></i>');
            $btn.prop('disabled', true);
            
            $.ajax({
                url: '/company/companies/' + companyId + '/iaf-eac/' + codeId + '/set-primary/',
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': csrfToken
                },
                success: function() {
                    showMessage('Primarni kod ažuriran', 
                               'IAF/EAC kod je uspešno postavljen kao primarni.', 
                               'success');
                    
                    setTimeout(function() {
                        window.location.reload();
                    }, 1500);
                },
                error: function(xhr, status, error) {
                    // Resetovanje dugmeta
                    $btn.html('<i class="fas fa-star"></i>');
                    $btn.prop('disabled', false);
                    
                    showMessage('Greška pri ažuriranju primarnog IAF/EAC koda', 
                              'Došlo je do greške pri ažuriranju primarnog IAF/EAC koda.', 
                              'error');
                }
            });
        });
    }
    
    // Pomoćna funkcija za prikazivanje poruka
    function showMessage(title, message, type) {
        console.log('Pozivanje showMessage funkcije:', title, message, type);
        console.log('showDirectModal funkcija dostupna:', typeof window.showDirectModal === 'function');
        
        if (typeof window.showDirectModal === 'function') {
            console.log('Pokušaj prikazivanja direktnog modala...');
            try {
                window.showDirectModal(title, message, type);
                console.log('Direktni modal uspešno prikazan');
            } catch (error) {
                console.error('Greška pri prikazivanju direktnog modala:', error);
                alert(title + '\n\n' + message);
            }
        } else {
            console.log('Prikazivanje alert poruke umesto modala');
            alert(message);
        }
    }
    
})(jQuery);

/**
 * Funkcionalnost za prikazivanje IAF/EAC kodova u tabeli
 */
(function($) {
    'use strict';
    
    $(document).ready(function() {
        var companyId = $('#iaf-eac-codes-list').data('company-id');
        if (companyId) {
            loadIafEacCodes(companyId);
        }
    });
    
    function loadIafEacCodes(companyId) {
        var $tableBody = $('#iaf-eac-codes-list');
        var $noCodesMsg = $('#no-iaf-codes-message');
        
        $.ajax({
            url: '/company/companies/' + companyId + '/iaf-eac/list/',
            type: 'GET',
            success: function(response) {
                $tableBody.empty();
                
                if (response.codes && response.codes.length > 0) {
                    $noCodesMsg.hide();
                    
                    $.each(response.codes, function(index, code) {
                        var statusBadge = code.is_primary ? 
                            '<span class="badge badge-success">Primarni</span>' : 
                            '<span class="badge badge-secondary">Sekundarni</span>';
                        
                        var actionButtons = `
                            <button class="btn btn-sm btn-outline-danger delete-iaf-eac-btn" 
                                    data-code-id="${code.id}" 
                                    data-company-id="${companyId}"
                                    data-code-name="${code.iaf_code}">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                        
                        if (!code.is_primary) {
                            actionButtons += `
                                <button class="btn btn-sm btn-outline-primary ml-1 set-primary-iaf-eac-btn" 
                                        data-code-id="${code.id}" 
                                        data-company-id="${companyId}">
                                    <i class="fas fa-star"></i>
                                </button>
                            `;
                        }
                        
                        var row = `
                            <tr>
                                <td>${code.iaf_code || 'N/A'}</td>
                                <td>${code.description || 'N/A'}</td>
                                <td>${statusBadge}</td>
                                <td>${code.notes || '-'}</td>
                                <td>${actionButtons}</td>
                            </tr>
                        `;
                        
                        $tableBody.append(row);
                    });
                } else {
                    $noCodesMsg.show();
                }
            },
            error: function() {
                $tableBody.html('<tr><td colspan="5" class="text-center text-danger">Greška pri učitavanju IAF/EAC kodova</td></tr>');
            }
        });
    }
    
})(jQuery);
</script>

<!-- Script za modalni prozor za brisanje standarda -->
<script>
/**
 * JavaScript za kreiranje i upravljanje modalom za brisanje standarda
 * 
 * Deo reorganizacije frontend koda ISOQAR aplikacije
 */

(function($) {
    'use strict';
    
    // Funkcija za kreiranje modala dinamički
    function createDeleteModal() {
        // Proveri da li modal već postoji
        if ($('#deleteStandardModal').length > 0) {
            console.log('Modal već postoji u DOM-u, neće biti kreiran ponovo.');
            return;
        }
        
        // Kreiraj modal HTML
        var modalHtml = `
            <div class="modal fade" id="deleteStandardModal" tabindex="-1" role="dialog" aria-labelledby="deleteStandardModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title" id="deleteStandardModalLabel">Potvrda brisanja standarda</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>Da li ste sigurni da želite da obrišete standard <strong id="standardNameToDelete"></strong>?</p>
                            <p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Ova akcija je nepovratna!</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Odustani</button>
                            <form id="deleteStandardForm" method="post" action="">
                                <input type="hidden" name="csrfmiddlewaretoken" value="">
                                <button type="submit" class="btn btn-danger">Obriši</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Dodaj modal na kraj body elementa
        $('body').append(modalHtml);
        
        // Postavi CSRF token
        var csrfToken = $('input[name="csrfmiddlewaretoken"]').first().val();
        $('#deleteStandardForm input[name="csrfmiddlewaretoken"]').val(csrfToken);
        
        console.log('Modal za brisanje standarda je dinamički kreiran i dodat u DOM.');
    }
    
    // Kada je dokument spreman
    $(document).ready(function() {
        console.log('Inicijalizacija dinamičkog modala za brisanje standarda...');
        
        // Kreiraj modal
        createDeleteModal();
        
        // Poveži event handler za dugmad za brisanje
        $(document).on('click', '.btn-delete-standard', function(e) {
            e.preventDefault();
            
            var standardId = $(this).data('standard-id');
            var standardName = $(this).data('standard-name');
            var companyId = $(this).data('company-id');
            
            console.log('Kliknuto brisanje standarda:', standardId, standardName, companyId);
            
            // Postavljanje vrednosti u modalu
            $('#standardNameToDelete').text(standardName);
            
            // Postavljanje URL-a za brisanje
            var deleteUrl = '/company/companies/' + companyId + '/standards/' + standardId + '/delete/';
            $('#deleteStandardForm').attr('action', deleteUrl);
            
            // Prikazivanje modala
            $('#deleteStandardModal').modal('show');
        });
        
        // Kada se modal pojavi
        $(document).on('shown.bs.modal', '#deleteStandardModal', function() {
            console.log('Modal za brisanje standarda je prikazan.');
        });
        
        // Kada se modal zatvori
        $(document).on('hidden.bs.modal', '#deleteStandardModal', function() {
            console.log('Modal za brisanje standarda je zatvoren.');
        });
    });
    
})(jQuery);
</script>

<!-- Script za prikaz modalnih poruka -->
<script>
/**
 * Modal za prikazivanje poruka
 * Deo reorganizacije frontend koda ISOQAR aplikacije
 */

(function($) {
    'use strict';
    
    // Globalna funkcija za prikazivanje poruka
    window.showDirectModal = function(title, message, type) {
        // Tip može biti: success, error, warning, info
        type = type || 'info';
        
        // Definisanje klase za header na osnovu tipa
        var headerClass = 'bg-info';
        var icon = 'fa-info-circle';
        
        if (type === 'success') {
            headerClass = 'bg-success';
            icon = 'fa-check-circle';
        } else if (type === 'error' || type === 'danger') {
            headerClass = 'bg-danger';
            icon = 'fa-exclamation-circle';
        } else if (type === 'warning') {
            headerClass = 'bg-warning';
            icon = 'fa-exclamation-triangle';
        }
        
        // Proveri da li modal već postoji
        var $modal = $('#directModal');
        if ($modal.length === 0) {
            // Kreiraj modal
            var modalHtml = `
                <div class="modal fade" id="directModal" tabindex="-1" role="dialog" aria-labelledby="directModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header text-white" id="directModalHeader">
                                <h5 class="modal-title" id="directModalTitle"></h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <p id="directModalMessage"></p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Zatvori</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $('body').append(modalHtml);
            $modal = $('#directModal');
        }
        
        // Ažuriraj sadržaj modala
        $('#directModalHeader').removeClass('bg-success bg-danger bg-warning bg-info').addClass(headerClass);
        $('#directModalTitle').html('<i class="fas ' + icon + '"></i> ' + title);
        $('#directModalMessage').html(message);
        
        // Prikaži modal
        $modal.modal('show');
    };
    
    console.log('Direktni modal sistem inicijalizovan. showDirectModal funkcija je dostupna:', typeof window.showDirectModal === 'function');
    
})(jQuery);
</script>

<!-- Script za direktno dodavanje standarda -->
<script>
/**
 * Standard Direct Add - Modul za direktno dodavanje standarda
 * Deo reorganizacije frontend koda ISOQAR aplikacije
 */

(function($) {
    'use strict';
    
    // Glavna funkcija za inicijalizaciju
    function initDirectStandardAdd() {
        console.log('Inicijalizacija direktnog dodavanja standarda...');
        
        // Zakačimo event handler na dugme
        $('#directStandardAdd').on('click', function(e) {
            e.preventDefault();
            handleDirectStandardAdd(this);
        });
    }
    
    // Funkcija koja obrađuje direktno dodavanje standarda
    function handleDirectStandardAdd(buttonElement) {
        // Prikupljanje podataka iz forme
        var standardDefinition = $('#standard_definition').val();
        var issueDate = $('#issue_date').val();
        var expiryDate = $('#expiry_date').val();
        var notes = $('#notes').val();
        var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
        
        // Validacija standarda
        if (!standardDefinition) {
            // Prikaži validacioni modal
            if (typeof window.showDirectModal === 'function') {
                window.showDirectModal(
                    'Potrebna validacija',
                    'Morate izabrati standard pre nego što nastavite.',
                    'warning'
                );
            } else {
                alert('Morate izabrati standard!');
            }
            $('#standard_definition').focus();
            return false;
        }
        
        // Prikupljanje URL-a i Company ID-a iz atributa dugmeta
        var $btn = $(buttonElement);
        var companyId = $btn.data('company-id');
        var addUrl = '/company/companies/' + companyId + '/standards/add/';
        
        // Formiranje podataka za slanje
        var formData = {
            'standard_definition': standardDefinition,
            'issue_date': issueDate,
            'expiry_date': expiryDate,
            'notes': notes,
            'csrfmiddlewaretoken': csrfToken
        };
        
        console.log('Direktno dodavanje standarda...');
        console.log('URL:', addUrl);
        console.log('Podaci:', formData);
        
        // Prikaz indikatora učitavanja na dugmetu
        var originalBtnText = $btn.html();
        $btn.html('<i class="fas fa-spinner fa-spin"></i> Dodajem...');
        $btn.prop('disabled', true);
        
        // Slanje AJAX zahteva
        $.ajax({
            url: addUrl,
            type: 'POST',
            data: formData,
            success: function(response) {
                console.log('Standard uspešno dodat!', response);
                
                // Čišćenje polja - ručno, bez resetovanja forme
                $('#standard_definition').val('');
                $('#issue_date').val('');
                $('#expiry_date').val('');
                $('#notes').val('');
                
                // Dohvati naziv dodatog standarda - sigurna verzija
                var standardName = '';
                try {
                    standardName = $('#standard_definition option:selected').text() || 'Odabrani standard';
                } catch (e) {
                    standardName = 'Standard';
                    console.error('Greška pri dohvatanju naziva standarda:', e);
                }
                
                // Prikaži modal za uspeh
                if (typeof window.showDirectModal === 'function') {
                    window.showDirectModal(
                        'Standard uspešno dodat',
                        'Standard "' + standardName + '" je uspešno dodat u sistem!',
                        'success'
                    );
                    
                    // Osveži stranicu nakon zatvaranja
                    setTimeout(function() {
                        window.location.reload();
                    }, 1500);
                } else {
                    alert('Standard uspešno dodat!');
                    window.location.reload();
                }
            },
            error: function(xhr, status, error) {
                console.error('Greška pri dodavanju standarda:', error);
                console.error('Status:', xhr.status);
                console.error('Odgovor:', xhr.responseText);
                
                // Resetovanje stanja dugmeta
                $btn.html(originalBtnText);
                $btn.prop('disabled', false);
                
                // Priprema poruke o grešci
                var errorMessage = 'Došlo je do greške pri dodavanju standarda.';
                
                // Pokušaj parsirati odgovor
                try {
                    if (xhr.responseText) {
                        var response = JSON.parse(xhr.responseText);
                        if (response.error) {
                            errorMessage += '\n\nDetalji: ' + response.error;
                        }
                    }
                } catch (e) {
                    if (xhr.status) {
                        errorMessage += '\n\nStatus kod: ' + xhr.status;
                    }
                }
                
                // Prikaži grešku
                if (typeof window.showDirectModal === 'function') {
                    window.showDirectModal(
                        'Greška pri dodavanju standarda',
                        errorMessage,
                        'error'
                    );
                } else {
                    alert(errorMessage);
                }
            }
        });
    }
    
    // Pokretanje inicijalizacije kada je dokument spreman
    $(document).ready(function() {
        initDirectStandardAdd();
    });
    
})(jQuery);
</script>

<!-- Napomena: Automatsko izračunavanje datuma isteka se sada vrši na backend strani -->
<script>
(function($) {
    'use strict';
    
    // Napomena: Automatsko izračunavanje datuma isteka se sada vrši na backend strani
    // u metodi save() modela CompanyStandard
    
})(jQuery);
</script>

<!-- IAF/EAC kodovi JavaScript -->
<script src="{% static 'js/company/company-iaf-eac.js' %}"></script>
{% endblock %}
